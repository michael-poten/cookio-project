import{I as q,G as fe,C as Be,R as me}from"./C6kbBVjZ.js";import{_ as Pe,M as Me,N as pe,O as Ne,J as Ae,P as Fe,K as ge,r as h,o as ke,k as N,g as C,x as g,y as a,z as d,B as n,Q as T,R as v,S as Q,C as s,D as _,A as b,T as X,U as Z,X as W}from"./CSQU4AtQ.js";import{I as U}from"./DA__SF9z.js";import{I as Ve}from"./C05MyEuc.js";import"./BtHaaEq5.js";const Oe={class:"text-right mt-3"},We={class:"mt-3"},He={class:"d-flex flex-column align-center"},Le={class:"d-flex flex-column align-center"},Je={class:"mx-3 mt-1",style:{"font-size":"1.6em"}},je={class:"mt-2"},Ke={key:0},Ye={key:1},Ge={class:"ml-2"},qe={key:2},Qe={key:3,class:"ml-2"},Xe={key:0},Ze={key:1},et={key:2},tt={key:0},ot={key:0},lt={key:0},nt={key:1},st={key:0},it={key:1,class:"mt-2"},at={style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em"},class:"pl-1"},rt={key:2},ut=["onClick"],ct={key:2},dt={key:3},vt={class:"mt-5 mb-3"},ft={class:"d-flex flex-column align-center"},mt={class:"mx-3 mt-1",style:{"font-size":"1.6em"}},pt={__name:"MealCalendar",setup(_e){const H=Me(),{recipes:B}=pe(H);Ne(),Ae(),Fe();const I=ge(),{authInfo:x,githubMode:L,lanAddress:ye}=pe(I),A=h(""),ee=h(!0),J=h(null),te=h(!1),oe=h("");h(null),h(!1);const P=h({}),l=h({}),D=h(0),j=h([]),he=new Date,K=h([]),F=h({}),De=h(null),le=h(null);ke(async()=>{console.log("mounted");let o=await I.getAuthInfo();o.icsUrl?(A.value=o.icsUrl,q.fetchIcsData(o.userId,o.icsUrl).then(e=>{setTimeout(()=>{J.value=e.data,$e()},200)})):ee.value=!1,await ae(),re(),ce()}),N(()=>B.value.filter(o=>!!o.planned));const ne=N(()=>{if(D.value<-1)return"Aktuelle Woche -"+Math.abs(D.value);if(D.value===-1)return"Letzte Woche";if(D.value===0)return"Aktuelle Woche";if(D.value===1)return"Nächste Woche";if(D.value===2)return"Übernächste Woche";if(D.value>2)return"Aktuelle Woche +"+D.value}),we=N(()=>{if(!l.value)return 0;let o=0,e=l.value;new Date().setHours(0,0,0,0);const c=new Date;c.setHours(23,59,59,0);for(let i=D.value*7;i<(D.value+1)*7;i++){const f=O(E,i);if(f.getTime()>c.getTime()){const y=f.getFullYear(),u=String(f.getMonth()+1).padStart(2,"0"),k=String(f.getDate()).padStart(2,"0");e[`${y}-${u}-${k}`]||o++}}return o}),Y=N(()=>B.value.filter(o=>!!o.planned&&!o.cooked)),Te=N(()=>{const o=new Date,e=o.getFullYear(),m=String(o.getMonth()+1).padStart(2,"0"),c=String(o.getDate()).padStart(2,"0");let i=0;for(const f of Object.keys(l.value)){const y=new Date(f).getFullYear(),u=String(new Date(f).getMonth()+1).padStart(2,"0"),k=String(new Date(f).getDate()).padStart(2,"0");l.value[f]&&!l.value[f].cooked&&l.value[f].type==="RECIPE"&&(new Date(f).getTime()>=o.getTime()||`${y}-${u}-${k}`==`${e}-${m}-${c}`)&&i++}return Y.value.length-i});async function Ce(){await q.saveIcsUrl(x.value.userId,A.value),re()}function se(o){return o?L.value?"https://mmhhhh.de/data/home/recipes/"+o+"/image.jpg":ye.value+"api/"+x.value.userId+"/recipes/"+o+"/image":""}async function z(o,e){if(!e){delete l.value[o],M(),await R(),await I.refreshPlannendUntil();return}l.value[o]||(l.value[o]={}),l.value[o].type=e,await R(),await I.refreshPlannendUntil()}function be(o){le.value().then(e=>{e&&z(o,null)})}async function Se(o,e){if(!e){delete l.value[o],M(),await R(),await I.refreshPlannendUntil();return}for(const c of Object.keys(l.value))l.value[c]&&!l.value[c].cooked&&l.value[c].recipeId===e&&delete l.value[c];l.value[o]||(l.value[o]={});const m=B.value.find(c=>c.id===e);l.value[o].recipeId=e,l.value[o].recipeTitle=m.title,M(),await R(),await I.refreshPlannendUntil()}async function ie(o){L.value?window.open("https://mmhhhh.de/recipes/go?id="+o,"_blank","noopener"):window.open("/recipes/go?id="+o,"_blank","noopener")}async function G(o){if(l.value[o].recipeId){const e={cooked:!0};await me.updateRecipe(x.value.userId,l.value[o].recipeId,e),await ae(),me.uploadRecipeToGithub(x.value.userId,null)}l.value[o].cooked=!0,await R()}async function ae(){B.value=await H.getAllRecipes(x.value.userId)}async function re(){let o=await I.getAuthInfo();l.value=o.calendarPlan??{},M()}function M(){j.value=[];for(const o of Object.keys(l.value))l.value[o]&&!l.value[o].cooked&&l.value[o].recipeId&&Y.value.map(e=>e.id).includes(l.value[o].recipeId)&&j.value.push(l.value[o].recipeId)}function V(o,e){D.value+=e,M(),o&&window.scrollTo({top:0,behavior:"smooth"}),ce()}async function R(){await q.saveCalendarPlan(x.value.userId,l.value)}function Ie(o){const e=new Date(o),m=e.getDay()||7;return m!==1&&e.setDate(e.getDate()-(m-1)),e.setHours(0,0,0,0),e}function O(o,e){const m=new Date(o);return m.setDate(m.getDate()+e),m}function ue(o){const e=o.getFullYear(),m=String(o.getMonth()+1).padStart(2,"0"),c=String(o.getDate()).padStart(2,"0");return`${e}-${m}-${c}`}const ze=new Intl.DateTimeFormat("de-DE",{weekday:"short"}),E=Ie(he);function ce(){const o=new Date;o.setHours(0,0,0,0),new Date().setHours(23,59,59,0);const m=[];for(let c=D.value*7;c<(D.value+1)*7;c++){const i=O(E,c),f=!(i.getTime()<o.getTime());m.push({date:i,open:f,iso:ue(i),weekdayShort:ze.format(i),isBeforeToday:i.getTime()<o.getTime(),isToday:Re(i)})}K.value=m}function Re(o){const e=new Date;return o.getFullYear()===e.getFullYear()&&o.getMonth()===e.getMonth()&&o.getDate()===e.getDate()}function $e(){if(oe.value="",!!J.value){te.value=!0;try{const o=J.value,e=U.parse(o),m=new U.Component(e),c=U.Time.fromJSDate(E,!0),i=U.Time.fromJSDate(O(E,21),!0),f=m.getAllSubcomponents("vevent");for(const y of f){const u=new U.Event(y);if(u.startDate)if(u.isRecurring()){const k=new U.RecurExpansion({component:y,dtstart:u.startDate});for(;;){const p=k.next();if(!p||p.compare(i)>=0)break;if(p.compare(c)<0)continue;const S=p;let w;u.duration?(w=S.clone(),w.addDuration(u.duration)):u.endDate?w=u.endDate.clone():w=S.clone(),de(u,S,w)}}else{const k=u.startDate,p=u.endDate||k;p.compare(c)<=0||k.compare(i)>=0||de(u,k,p)}}}catch(o){console.error(o),oe.value="Kalender konnte nicht geladen werden. (CORS/URL/Format prüfen)"}finally{te.value=!1}}}function de(o,e,m){const c=e.toJSDate(),i=m.toJSDate(),f=e.isDate,y=new Date(i);f&&y.setDate(y.getDate()-1);const u=E,k=O(E,20),p=c<u?u:c,S=y>k?k:y;for(let w=new Date(p.getFullYear(),p.getMonth(),p.getDate());w<=S;w.setDate(w.getDate()+1)){const $=ue(w);P.value[$]||(P.value[$]=[]),P.value[$].push({summary:o.summary,location:o.location,organizer:o.organizer,allDay:f,start:c,end:i})}}function xe(o){if(o.allDay)return"Ganztägig";const e=new Intl.DateTimeFormat("de-DE",{hour:"2-digit",minute:"2-digit"});return`${e.format(o.start)}–${e.format(o.end)}`}return(o,e)=>{const m=C("v-card-title"),c=C("v-text-field"),i=C("v-btn"),f=C("v-card-text"),y=C("v-card"),u=C("v-icon"),k=C("v-row"),p=C("v-col"),S=C("v-img"),w=C("v-alert-title"),$=C("v-alert"),Ee=C("v-divider");return a(),g("div",null,[e[31]||(e[31]=d("h2",{class:"mt-6 text-center"},"Kalender",-1)),d("div",null,[!ee.value&&!Q(L)?(a(),T(y,{key:0,class:"mt-3 mb-4"},{default:s(()=>[n(m,null,{default:s(()=>[...e[9]||(e[9]=[_(" Termine anzeigen ",-1)])]),_:1}),n(f,null,{default:s(()=>[n(c,{modelValue:A.value,"onUpdate:modelValue":e[0]||(e[0]=t=>A.value=t),class:"mt-2","hide-details":"auto",label:"URL zur ics-Datei"},null,8,["modelValue"]),d("div",Oe,[n(i,{variant:"outlined",onClick:Ce},{default:s(()=>[...e[10]||(e[10]=[_("Speichern",-1)])]),_:1})])]),_:1})]),_:1})):v("",!0),d("div",We,[d("div",He,[d("div",Le,[n(y,{class:"pa-2",variant:"elevated"},{default:s(()=>[n(f,null,{default:s(()=>[n(k,null,{default:s(()=>[n(i,{onClick:e[1]||(e[1]=t=>V(!1,-1))},{default:s(()=>[n(u,{icon:"mdi-chevron-left"})]),_:1}),d("div",Je,b(ne.value),1),n(i,{onClick:e[2]||(e[2]=t=>V(!1,1))},{default:s(()=>[n(u,{icon:"mdi-chevron-right"})]),_:1})]),_:1})]),_:1})]),_:1})])]),d("div",je," Offene Tage: "+b(we.value),1)]),(a(!0),g(X,null,Z(K.value,(t,Ue)=>(a(),g("div",{key:t.iso},[n(y,{class:"mt-2",flat:"",color:t.isBeforeToday?"rgb(236,236,236)":t.isToday?"rgb(183, 206, 226)":"white"},{default:s(()=>[n(m,{style:W({color:t.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[l.value[t.iso]?(a(),g("span",Ke,[n(u,{icon:"mdi-check",size:"30",color:"green"})])):v("",!0),l.value[t.iso]?v("",!0):(a(),g("span",Ye,[n(u,{icon:"mdi-close",size:"30",color:"red"})])),d("span",Ge,b(t.weekdayShort)+", "+b(t.date.getDate())+"."+b((t.date.getMonth()+1).toString().padStart(2,"0")),1),l.value[t.iso]?(a(),g("span",qe,[n(i,{variant:"plain",class:"ma-1",onClick:r=>be(t.iso)},{default:s(()=>[...e[11]||(e[11]=[_(" Löschen ",-1)])]),_:1},8,["onClick"])])):v("",!0),!t.open&&t.isBeforeToday&&l.value[t.iso]&&l.value[t.iso].cooked?(a(),g("span",Qe,[l.value[t.iso].type==="RECIPE"?(a(),g("span",Xe,[n(u,{icon:"mdi-bowl-mix",size:"30"})])):v("",!0),l.value[t.iso].type==="SCHEDULED"?(a(),g("span",Ze,[n(u,{icon:"mdi-food"})])):v("",!0),l.value[t.iso].type==="OTHER"?(a(),g("span",et,[n(u,{icon:"mdi-crosshairs-question"})])):v("",!0),n(i,{variant:"plain",class:"ma-1",onClick:r=>t.open=!0},{default:s(()=>[...e[12]||(e[12]=[_(" Aufklappen ",-1)])]),_:1},8,["onClick"])])):v("",!0)]),_:2},1032,["style"]),t.open||t.isBeforeToday&&l.value[t.iso]&&!l.value[t.iso].cooked?(a(),T(f,{key:0,style:{"min-height":"80px"}},{default:s(()=>[n(k,null,{default:s(()=>[n(p,{cols:o.$vuetify.display.mobile?12:4},{default:s(()=>[!t.isBeforeToday&&D.value>=0?(a(),T(y,{key:0,flat:"",color:"white"},{default:s(()=>[n(f,{class:"pa-1",style:W({color:t.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[(a(!0),g(X,null,Z(P.value[t.iso]??[],(r,ve)=>(a(),g("div",{key:ve},[r&&!r.recipe?(a(),g("div",tt,[d("div",null,[d("span",null,[d("b",null,b(xe(r)),1)]),e[13]||(e[13]=_()),d("span",null,b(r.summary||"Ohne Titel"),1)])])):v("",!0)]))),128)),(P.value[t.iso]??[]).length===0?(a(),g("div",ot,"Keine Termine")):v("",!0)]),_:2},1032,["style"])]),_:2},1024)):v("",!0)]),_:2},1032,["cols"]),n(p,null,{default:s(()=>[l.value[t.iso]?v("",!0):(a(),g("div",lt,[d("div",null,[n(i,{"prepend-icon":"mdi-bowl-mix",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:r=>z(t.iso,"RECIPE"),disabled:t.isBeforeToday||Te.value===0},null,8,["onClick","disabled"]),n(i,{"prepend-icon":"mdi-food",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:r=>z(t.iso,"SCHEDULED"),disabled:t.isBeforeToday},null,8,["onClick","disabled"]),n(i,{"prepend-icon":"mdi-crosshairs-question",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:r=>z(t.iso,"OTHER"),disabled:t.isBeforeToday},null,8,["onClick","disabled"])])])),l.value[t.iso]&&l.value[t.iso].type==="RECIPE"?(a(),g("div",nt,[l.value[t.iso].recipeId?v("",!0):(a(),g("div",st,[n(k,{"no-gutters":""},{default:s(()=>[n(p,{cols:"3"},{default:s(()=>[n(u,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),n(p,{class:"pl-1 mt-4"},{default:s(()=>[e[16]||(e[16]=_(" Rezept ",-1)),n(i,{variant:"flat",color:l.value[t.iso].recipeId||l.value[t.iso].recipeSelection?"grey":"blue",onClick:r=>l.value[t.iso].recipeSelection=!1,class:"mb-1"},{default:s(()=>[...e[14]||(e[14]=[_("offen lassen",-1)])]),_:1},8,["color","onClick"]),e[17]||(e[17]=_(" oder ",-1)),n(i,{variant:"flat",color:l.value[t.iso].recipeId||l.value[t.iso].recipeSelection?"blue":"grey",onClick:r=>l.value[t.iso].recipeSelection=!0,class:"mb-1"},{default:s(()=>[...e[15]||(e[15]=[_("konkretes Rezept",-1)])]),_:1},8,["color","onClick"]),e[18]||(e[18]=_(" auswählen? ",-1))]),_:2},1024)]),_:2},1024)])),!l.value[t.iso].recipeId&&l.value[t.iso].recipeSelection?(a(),g("div",it,[e[19]||(e[19]=d("h3",null,"Bitte Rezept auswählen:",-1)),n(k,{align:"center"},{default:s(()=>[(a(!0),g(X,null,Z(Y.value,r=>(a(),T(p,{key:r.id,cols:"6"},{default:s(()=>[n(y,null,{default:s(()=>[(a(),T(S,{class:"position-relative",height:"100",src:se(r.id),key:F.value[r.id]?F.value[r.id]:0,style:W({opacity:j.value.includes(r.id)?.3:1}),cover:"",onClick:ve=>Se(t.iso,r.id)},null,8,["src","style","onClick"])),d("div",at,b(r.title||"Ohne Titel"),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)])):v("",!0),l.value[t.iso].recipeId?(a(),g("div",rt,[!l.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(a(),T($,{key:0,type:"info",class:"mb-4",color:"rgb(166, 190, 226)"},{default:s(()=>[n(w,{style:{"font-size":"1.3em"}},{default:s(()=>[e[22]||(e[22]=_("Wurde diese Mahlzeit zubereitet? ",-1)),n(i,{variant:"outlined",onClick:r=>G(t.iso),class:"ml-3"},{default:s(()=>[...e[20]||(e[20]=[_("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?v("",!0):(a(),T(i,{key:0,variant:"outlined",onClick:r=>z(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[21]||(e[21]=[_("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):v("",!0),n(k,{"no-gutters":""},{default:s(()=>[n(p,{cols:"3"},{default:s(()=>[n(u,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),n(p,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[(a(),T(S,{class:"position-relative",height:"120",src:se(l.value[t.iso].recipeId),key:F.value[l.value[t.iso].recipeId]?F.value[l.value[t.iso].recipeId]:0,style:W([{opacity:t.isBeforeToday?.6:1},{cursor:"pointer"}]),color:"grey",onClick:r=>ie(l.value[t.iso].recipeId),cover:""},null,8,["src","style","onClick"])),d("div",{style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em",cursor:"pointer"},class:"pl-1",onClick:r=>ie(l.value[t.iso].recipeId)},b(l.value[t.iso].recipeTitle||"Ohne Titel"),9,ut)]),_:2},1024)]),_:2},1024)])):v("",!0)])):v("",!0),l.value[t.iso]&&l.value[t.iso].type==="SCHEDULED"?(a(),g("div",ct,[!l.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(a(),T($,{key:0,type:"info",class:"mb-4",color:"rgb(166, 190, 226)"},{default:s(()=>[n(w,{style:{"font-size":"1.3em"}},{default:s(()=>[e[25]||(e[25]=_("Wurde diese Mahlzeit verzehrt? ",-1)),n(i,{variant:"outlined",onClick:r=>G(t.iso),class:"ml-3"},{default:s(()=>[...e[23]||(e[23]=[_("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?v("",!0):(a(),T(i,{key:0,variant:"outlined",onClick:r=>z(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[24]||(e[24]=[_("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):v("",!0),n(k,{"no-gutters":""},{default:s(()=>[n(p,{cols:"3"},{default:s(()=>[n(u,{icon:"mdi-food",size:"50"})]),_:1}),n(p,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[d("div",null,[e[26]||(e[26]=d("div",null," Auswärts / Lieferung ",-1)),d("div",null,[n(c,{label:"Notizen (optional)",modelValue:l.value[t.iso].recipeTitle,"onUpdate:modelValue":r=>l.value[t.iso].recipeTitle=r,onKeyup:e[3]||(e[3]=r=>Q(fe).debounceTime("scheduledPlanTitle",R,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):v("",!0),l.value[t.iso]&&l.value[t.iso].type==="OTHER"?(a(),g("div",dt,[!l.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(a(),T($,{key:0,type:"info",class:"mb-2",color:"rgb(166, 190, 226)"},{default:s(()=>[n(w,{style:{"font-size":"1.3em"}},{default:s(()=>[e[29]||(e[29]=_("Wurde diese Mahlzeit verzehrt? ",-1)),n(i,{variant:"outlined",onClick:r=>G(t.iso),class:"ml-3"},{default:s(()=>[...e[27]||(e[27]=[_("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?v("",!0):(a(),T(i,{key:0,variant:"outlined",onClick:r=>z(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[28]||(e[28]=[_("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):v("",!0),n(k,{"no-gutters":""},{default:s(()=>[n(p,{cols:"3"},{default:s(()=>[n(u,{icon:"mdi-crosshairs-question",size:"50"})]),_:1}),n(p,{style:{"font-size":"1.6em"},class:"ml-2 pl-1"},{default:s(()=>[d("div",null,[e[30]||(e[30]=d("div",null," Sonstiges ",-1)),d("div",null,[n(c,{label:"Notizen (optional)",modelValue:l.value[t.iso].recipeTitle,"onUpdate:modelValue":r=>l.value[t.iso].recipeTitle=r,onKeyup:e[4]||(e[4]=r=>Q(fe).debounceTime("otherPlanNotes",R,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):v("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)):v("",!0)]),_:2},1032,["color"]),Ue!==K.value.length-1?(a(),T(Ee,{key:0,class:"my-2",opacity:"0.7"})):v("",!0)]))),128)),d("div",vt,[d("div",ft,[n(y,{class:"pa-2",variant:"elevated"},{default:s(()=>[n(f,null,{default:s(()=>[n(k,null,{default:s(()=>[n(i,{onClick:e[5]||(e[5]=t=>V(!0,-1))},{default:s(()=>[n(u,{icon:"mdi-chevron-left"})]),_:1}),d("div",mt,b(ne.value),1),n(i,{onClick:e[6]||(e[6]=t=>V(!0,1))},{default:s(()=>[n(u,{icon:"mdi-chevron-right"})]),_:1})]),_:1})]),_:1})]),_:1})])])]),n(Ve,{onResult:e[7]||(e[7]=t=>De.value=t)}),n(Be,{onResult:e[8]||(e[8]=t=>le.value=t),title:"Bitte bestätigen",message:"Soll die ausgewählte Mahlzeit für den Tag gelöscht werden?"})])}}},gt=Pe(pt,[["__scopeId","data-v-9055b3cb"]]),wt={__name:"index",setup(_e){return ke(async()=>{ge()}),(H,B)=>(a(),T(gt))}};export{wt as default};
