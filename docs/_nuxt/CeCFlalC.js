import{a as q,I as Pe,C as Ve,R as fe}from"./DZK96omx.js";import{_ as he,M as Me,N as me,O as Oe,J as Ne,P as He,K as ge,r as _,o as ke,k as Q,g as w,x as k,y as a,z as v,B as n,Q as T,R as c,U as X,C as s,D as d,A as S,S as Z,T as ee,a2 as F}from"./Ds6spcz5.js";import{I as P}from"./DA__SF9z.js";import"./B1YF1_9P.js";import{G as pe}from"./CI608YEO.js";const Fe={class:"text-right mt-3"},Ae={class:"mt-3 mb-3"},Le={class:"d-flex flex-column align-center"},We={class:"mt-2"},Je={key:0},je={key:1},Ke={key:2},Ye={key:0},Ge={key:0},qe={key:0},Qe={key:1},Xe={key:0},Ze={style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em"},class:"pl-1"},et={key:1},tt=["onClick"],lt={key:2},ot={key:3},nt={class:"mt-5 mb-3"},st={class:"d-flex flex-column align-center"},it={__name:"MealCalendar",setup(ye){const A=Me(),{recipes:V}=me(A);Oe(),Ne(),He();const $=ge(),{authInfo:x,githubMode:L,lanAddress:De}=me($),O=_(""),te=_(!0),W=_(null),le=_(!1),oe=_("");_(null),_(!1);const h=_({}),o=_({}),I=_(0),J=_([]),Ce=new Date,j=_([]),N=_({}),_e=_(null),ne=_(null);ke(async()=>{console.log("mounted");let l=await $.getAuthInfo();l.icsUrl?(O.value=l.icsUrl,q.fetchIcsData(l.userId,l.icsUrl).then(e=>{setTimeout(()=>{W.value=e.data,Re()},200)})):te.value=!1,await ae(),ue(),de()}),Q(()=>V.value.filter(l=>!!l.planned));const Te=Q(()=>{if(!o.value)return 0;let l=0,e=o.value;new Date().setHours(0,0,0,0);const r=new Date;r.setHours(23,59,59,0);for(let i=I.value*7;i<(I.value+1)*7;i++){const C=H(B,i);if(C.getTime()>r.getTime()){const y=C.getFullYear(),m=String(C.getMonth()+1).padStart(2,"0"),g=String(C.getDate()).padStart(2,"0");(!e[`${y}-${m}-${g}`]||e[`${y}-${m}-${g}`].type==="RECIPE"&&!e[`${y}-${m}-${g}`].recipeId)&&l++}}return l}),K=Q(()=>V.value.filter(l=>!!l.planned&&!l.cooked));function we(l){l.open=!0}async function be(){await q.saveIcsUrl(x.value.userId,O.value),ue()}function se(l){return l?L.value?"https://mmhhhh.de/data/home/recipes/"+l+"/image.jpg":De.value+"api/"+x.value.userId+"/recipes/"+l+"/image":""}async function E(l,e){if(!e){delete o.value[l],M(),await R(),await $.refreshPlannendUntil();return}o.value[l]||(o.value[l]={}),o.value[l].type=e,await R(),await $.refreshPlannendUntil()}function Ie(l){ne.value().then(e=>{e&&E(l,null)})}async function ze(l,e){if(!e){delete o.value[l],M(),await R(),await $.refreshPlannendUntil();return}for(const r of Object.keys(o.value))o.value[r]&&!o.value[r].cooked&&o.value[r].recipeId===e&&delete o.value[r];o.value[l]||(o.value[l]={});const f=V.value.find(r=>r.id===e);o.value[l].recipeId=e,o.value[l].recipeTitle=f.title,M(),await R(),await $.refreshPlannendUntil()}async function ie(l){L.value?window.open("https://mmhhhh.de/recipes/go?id="+l,"_blank","noopener"):window.open("/recipes/go?id="+l,"_blank","noopener")}async function Y(l){if(o.value[l].recipeId){const e={cooked:!0};await fe.updateRecipe(x.value.userId,recipeId,e),await ae(),fe.uploadRecipeToGithub(x.value.userId,null)}o.value[l].cooked=!0,await R()}async function ae(){V.value=await A.getAllRecipes(x.value.userId)}async function ue(){let l=await $.getAuthInfo();o.value=l.calendarPlan??{},console.log("plansByDay",o.value);for(const e of Object.keys(o.value))o.value[e]&&o.value[e].type==="RECIPE"&&!o.value[e].recipeId&&delete o.value[e];M()}function M(){J.value=[];for(const l of Object.keys(o.value))o.value[l]&&!o.value[l].cooked&&o.value[l].recipeId&&K.value.map(e=>e.id).includes(o.value[l].recipeId)&&J.value.push(o.value[l].recipeId)}function b(l){M(),de()}async function R(){await q.saveCalendarPlan(x.value.userId,o.value)}function Se(l){const e=new Date(l),f=e.getDay()||7;return f!==1&&e.setDate(e.getDate()-(f-1)),e.setHours(0,0,0,0),e}function H(l,e){const f=new Date(l);return f.setDate(f.getDate()+e),f}function re(l){const e=l.getFullYear(),f=String(l.getMonth()+1).padStart(2,"0"),r=String(l.getDate()).padStart(2,"0");return`${e}-${f}-${r}`}const $e=new Intl.DateTimeFormat("de-DE",{weekday:"short"}),B=Se(Ce);function de(){const l=new Date;l.setHours(0,0,0,0),new Date().setHours(23,59,59,0);const f=[];for(let r=I.value*7;r<(I.value+1)*7;r++){const i=H(B,r),C=!(i.getTime()<l.getTime());f.push({date:i,open:C,iso:re(i),weekdayShort:$e.format(i),isBeforeToday:i.getTime()<l.getTime(),isToday:Ee(i)})}j.value=f}function Ee(l){const e=new Date;return l.getFullYear()===e.getFullYear()&&l.getMonth()===e.getMonth()&&l.getDate()===e.getDate()}function Re(){if(oe.value="",!!W.value){le.value=!0;try{const l=W.value,e=P.parse(l),f=new P.Component(e),r=P.Time.fromJSDate(B,!0),i=P.Time.fromJSDate(H(B,21),!0),C=f.getAllSubcomponents("vevent");for(const y of C){const m=new P.Event(y);if(m.startDate)if(m.isRecurring()){const g=new P.RecurExpansion({component:y,dtstart:m.startDate});for(;;){const p=g.next();if(!p||p.compare(i)>=0)break;if(p.compare(r)<0)continue;const z=p;let D;m.duration?(D=z.clone(),D.addDuration(m.duration)):m.endDate?D=m.endDate.clone():D=z.clone(),ve(m,z,D)}}else{const g=m.startDate,p=m.endDate||g;p.compare(r)<=0||g.compare(i)>=0||ve(m,g,p)}}}catch(l){console.error(l),oe.value="Kalender konnte nicht geladen werden. (CORS/URL/Format prüfen)"}finally{le.value=!1}}}function ve(l,e,f){const r=e.toJSDate(),i=f.toJSDate(),C=e.isDate,y=new Date(i);C&&y.setDate(y.getDate()-1);const m=B,g=H(B,20),p=r<m?m:r,z=y>g?g:y;for(let D=new Date(p.getFullYear(),p.getMonth(),p.getDate());D<=z;D.setDate(D.getDate()+1)){const U=re(D);h.value[U]||(h.value[U]=[]),h.value[U].push({summary:l.summary,location:l.location,organizer:l.organizer,allDay:C,start:r,end:i})}}function Ue(l){if(l.allDay)return"Ganztägig";const e=new Intl.DateTimeFormat("de-DE",{hour:"2-digit",minute:"2-digit"});return`${e.format(l.start)}–${e.format(l.end)}`}return(l,e)=>{const f=w("v-card-title"),r=w("v-text-field"),i=w("v-btn"),C=w("v-card-text"),y=w("v-card"),m=w("v-btn-toggle"),g=w("v-icon"),p=w("v-col"),z=w("v-img"),D=w("v-row"),U=w("v-alert-title"),G=w("v-alert"),xe=w("v-divider");return a(),k("div",null,[e[44]||(e[44]=v("h2",{class:"mt-6 text-center"},"Kalender",-1)),v("div",null,[!te.value&&!X(L)?(a(),T(y,{key:0,class:"mt-3 mb-4"},{default:s(()=>[n(f,null,{default:s(()=>[...e[17]||(e[17]=[d(" Termine anzeigen ",-1)])]),_:1}),n(C,null,{default:s(()=>[n(r,{modelValue:O.value,"onUpdate:modelValue":e[0]||(e[0]=t=>O.value=t),class:"mt-2","hide-details":"auto",label:"URL zur ics-Datei"},null,8,["modelValue"]),v("div",Fe,[n(i,{variant:"outlined",onClick:be},{default:s(()=>[...e[18]||(e[18]=[d("Speichern",-1)])]),_:1})])]),_:1})]),_:1})):c("",!0),v("div",Ae,[v("div",Le,[n(m,{modelValue:I.value,"onUpdate:modelValue":e[6]||(e[6]=t=>I.value=t),color:"primary",border:"",mandatory:""},{default:s(()=>[n(i,{value:-2,style:{"font-size":"0.7em"},onClick:e[1]||(e[1]=t=>b(!1))},{default:s(()=>[...e[19]||(e[19]=[d("-2",-1)])]),_:1}),n(i,{value:-1,style:{"font-size":"0.7em"},onClick:e[2]||(e[2]=t=>b(!1))},{default:s(()=>[...e[20]||(e[20]=[d("-1",-1)])]),_:1}),n(i,{value:0,style:{"font-size":"0.7em"},onClick:e[3]||(e[3]=t=>b(!1))},{default:s(()=>[...e[21]||(e[21]=[d("Diese Woche",-1)])]),_:1}),n(i,{value:1,style:{"font-size":"0.7em"},onClick:e[4]||(e[4]=t=>b(!1))},{default:s(()=>[...e[22]||(e[22]=[d("+1",-1)])]),_:1}),n(i,{value:2,style:{"font-size":"0.7em"},onClick:e[5]||(e[5]=t=>b(!1))},{default:s(()=>[...e[23]||(e[23]=[d("+2",-1)])]),_:1})]),_:1},8,["modelValue"])]),v("div",We," Offene Tage: "+S(Te.value),1)]),(a(!0),k(Z,null,ee(j.value,(t,Be)=>(a(),k("div",{key:t.iso},[n(y,{class:"mt-2",flat:"",color:t.isBeforeToday?"rgb(236,236,236)":t.isToday?"rgb(183, 206, 226)":"white"},{default:s(()=>[n(f,{style:F({color:t.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[o.value[t.iso]&&(o.value[t.iso].type==="SCHEDULED"||o.value[t.iso].type==="OTHER"||o.value[t.iso].type==="RECIPE"&&o.value[t.iso].recipeId)?(a(),k("span",Je,[n(g,{icon:"mdi-check",size:"30",color:"green"})])):c("",!0),!o.value[t.iso]||o.value[t.iso].type==="RECIPE"&&!o.value[t.iso].recipeId?(a(),k("span",je,[n(g,{icon:"mdi-close",size:"30",color:"red"})])):c("",!0),d(" "+S(t.weekdayShort)+", "+S(t.date.getDate())+"."+S((t.date.getMonth()+1).toString().padStart(2,"0"))+" ",1),o.value[t.iso]&&(o.value[t.iso].type==="SCHEDULED"||o.value[t.iso].type==="OTHER"||o.value[t.iso].type==="RECIPE"&&o.value[t.iso].recipeId)&&!(!o.value[t.iso].cooked&&t.isBeforeToday)&&t.open?(a(),k("span",Ke,[n(i,{variant:"plain",class:"ma-1",onClick:u=>Ie(t.iso)},{default:s(()=>[...e[24]||(e[24]=[d(" Löschen ",-1)])]),_:1},8,["onClick"])])):c("",!0),!t.open&&t.isBeforeToday&&o.value[t.iso]&&o.value[t.iso].cooked?(a(),T(i,{key:3,variant:"plain",class:"ma-1",onClick:u=>we(t)},{default:s(()=>[...e[25]||(e[25]=[d(" Mehr ",-1)])]),_:1},8,["onClick"])):c("",!0)]),_:2},1032,["style"]),t.open||t.isBeforeToday&&o.value[t.iso]&&!o.value[t.iso].cooked?(a(),T(C,{key:0,style:{"min-height":"80px"}},{default:s(()=>[n(D,null,{default:s(()=>[n(p,{cols:l.$vuetify.display.mobile?12:4},{default:s(()=>[!t.isBeforeToday&&I.value>=0?(a(),T(y,{key:0,flat:"",color:"white"},{default:s(()=>[n(C,{class:"pa-1",style:F({color:t.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[(a(!0),k(Z,null,ee(h.value[t.iso]??[],(u,ce)=>(a(),k("div",{key:ce},[u&&!u.recipe?(a(),k("div",Ye,[v("div",null,[v("span",null,[v("b",null,S(Ue(u)),1)]),e[26]||(e[26]=d()),v("span",null,S(u.summary||"Ohne Titel"),1)])])):c("",!0)]))),128)),(h.value[t.iso]??[]).length===0?(a(),k("div",Ge,"Keine Termine")):c("",!0)]),_:2},1032,["style"])]),_:2},1024)):c("",!0)]),_:2},1032,["cols"]),n(p,null,{default:s(()=>[o.value[t.iso]?c("",!0):(a(),k("div",qe,[v("div",null,[n(i,{"prepend-icon":"mdi-bowl-mix",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:u=>E(t.iso,"RECIPE"),disabled:t.isBeforeToday||K.value.length===0},null,8,["onClick","disabled"]),n(i,{"prepend-icon":"mdi-food",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:u=>E(t.iso,"SCHEDULED"),disabled:t.isBeforeToday},null,8,["onClick","disabled"]),n(i,{"prepend-icon":"mdi-crosshairs-question",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:u=>E(t.iso,"OTHER"),disabled:t.isBeforeToday},null,8,["onClick","disabled"])])])),o.value[t.iso]&&o.value[t.iso].type==="RECIPE"?(a(),k("div",Qe,[o.value[t.iso].recipeId?c("",!0):(a(),k("div",Xe,[e[27]||(e[27]=v("h3",null,"Bitte Rezept auswählen:",-1)),n(D,{align:"center"},{default:s(()=>[(a(!0),k(Z,null,ee(K.value,u=>(a(),T(p,{key:u.id,cols:"6"},{default:s(()=>[n(y,null,{default:s(()=>[(a(),T(z,{class:"position-relative",height:"100",src:se(u.id),key:N.value[u.id]?N.value[u.id]:0,style:F({opacity:J.value.includes(u.id)?.3:1}),cover:"",onClick:ce=>ze(t.iso,u.id)},null,8,["src","style","onClick"])),v("div",Ze,S(u.title||"Ohne Titel"),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)])),o.value[t.iso].recipeId?(a(),k("div",et,[!o.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(a(),T(G,{key:0,type:"info",class:"mb-4",color:"rgb(166, 190, 226)"},{default:s(()=>[n(U,{style:{"font-size":"1.3em"}},{default:s(()=>[e[30]||(e[30]=d("Wurde diese Mahlzeit zubereitet? ",-1)),n(i,{variant:"outlined",onClick:u=>Y(t.iso),class:"ml-3"},{default:s(()=>[...e[28]||(e[28]=[d("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?c("",!0):(a(),T(i,{key:0,variant:"outlined",onClick:u=>E(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[29]||(e[29]=[d("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):c("",!0),n(D,{"no-gutters":""},{default:s(()=>[n(p,{cols:"3"},{default:s(()=>[n(g,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),n(p,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[(a(),T(z,{class:"position-relative",height:"120",src:se(o.value[t.iso].recipeId),key:N.value[o.value[t.iso].recipeId]?N.value[o.value[t.iso].recipeId]:0,style:F([{opacity:t.isBeforeToday?.6:1},{cursor:"pointer"}]),color:"grey",onClick:u=>ie(o.value[t.iso].recipeId),cover:""},null,8,["src","style","onClick"])),v("div",{style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em",cursor:"pointer"},class:"pl-1",onClick:u=>ie(o.value[t.iso].recipeId)},S(o.value[t.iso].recipeTitle||"Ohne Titel"),9,tt)]),_:2},1024)]),_:2},1024)])):c("",!0)])):c("",!0),o.value[t.iso]&&o.value[t.iso].type==="SCHEDULED"?(a(),k("div",lt,[!o.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(a(),T(G,{key:0,type:"info",class:"mb-4",color:"rgb(166, 190, 226)"},{default:s(()=>[n(U,{style:{"font-size":"1.3em"}},{default:s(()=>[e[33]||(e[33]=d("Wurde diese Mahlzeit verzehrt? ",-1)),n(i,{variant:"outlined",onClick:u=>Y(t.iso),class:"ml-3"},{default:s(()=>[...e[31]||(e[31]=[d("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?c("",!0):(a(),T(i,{key:0,variant:"outlined",onClick:u=>E(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[32]||(e[32]=[d("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):c("",!0),n(D,{"no-gutters":""},{default:s(()=>[n(p,{cols:"3"},{default:s(()=>[n(g,{icon:"mdi-food",size:"50"})]),_:1}),n(p,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[v("div",null,[e[34]||(e[34]=v("div",null," Auswärts / Lieferung / Verzehrfertig ",-1)),v("div",null,[n(r,{label:"Notizen (optional)",modelValue:o.value[t.iso].recipeTitle,"onUpdate:modelValue":u=>o.value[t.iso].recipeTitle=u,onKeyup:e[7]||(e[7]=u=>X(pe).debounceTime("scheduledPlanTitle",R,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):c("",!0),o.value[t.iso]&&o.value[t.iso].type==="OTHER"?(a(),k("div",ot,[!o.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(a(),T(G,{key:0,type:"info",class:"mb-2",color:"rgb(166, 190, 226)"},{default:s(()=>[n(U,{style:{"font-size":"1.3em"}},{default:s(()=>[e[37]||(e[37]=d("Wurde diese Mahlzeit verzehrt? ",-1)),n(i,{variant:"outlined",onClick:u=>Y(t.iso),class:"ml-3"},{default:s(()=>[...e[35]||(e[35]=[d("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?c("",!0):(a(),T(i,{key:0,variant:"outlined",onClick:u=>E(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[36]||(e[36]=[d("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):c("",!0),n(D,{"no-gutters":""},{default:s(()=>[n(p,{cols:"3"},{default:s(()=>[n(g,{icon:"mdi-crosshairs-question",size:"50"})]),_:1}),n(p,{style:{"font-size":"1.6em"},class:"ml-2 pl-1"},{default:s(()=>[v("div",null,[e[38]||(e[38]=v("div",null," Sonstiges ",-1)),v("div",null,[n(r,{label:"Name des Rezepts (optional)",modelValue:o.value[t.iso].recipeTitle,"onUpdate:modelValue":u=>o.value[t.iso].recipeTitle=u,onKeyup:e[8]||(e[8]=u=>X(pe).debounceTime("otherPlanNotes",R,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):c("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)):c("",!0)]),_:2},1032,["color"]),Be!==j.value.length-1?(a(),T(xe,{key:0,class:"my-2",opacity:"0.7"})):c("",!0)]))),128)),v("div",nt,[v("div",st,[n(m,{modelValue:I.value,"onUpdate:modelValue":e[14]||(e[14]=t=>I.value=t),color:"primary",border:"",mandatory:""},{default:s(()=>[n(i,{value:-2,style:{"font-size":"0.7em"},onClick:e[9]||(e[9]=t=>b(!1))},{default:s(()=>[...e[39]||(e[39]=[d("-2",-1)])]),_:1}),n(i,{value:-1,style:{"font-size":"0.7em"},onClick:e[10]||(e[10]=t=>b(!1))},{default:s(()=>[...e[40]||(e[40]=[d("-1",-1)])]),_:1}),n(i,{value:0,style:{"font-size":"0.7em"},onClick:e[11]||(e[11]=t=>b(!1))},{default:s(()=>[...e[41]||(e[41]=[d("Diese Woche",-1)])]),_:1}),n(i,{value:1,style:{"font-size":"0.7em"},onClick:e[12]||(e[12]=t=>b(!1))},{default:s(()=>[...e[42]||(e[42]=[d("+1",-1)])]),_:1}),n(i,{value:2,style:{"font-size":"0.7em"},onClick:e[13]||(e[13]=t=>b(!1))},{default:s(()=>[...e[43]||(e[43]=[d("+2",-1)])]),_:1})]),_:1},8,["modelValue"])])])]),n(Pe,{onResult:e[15]||(e[15]=t=>_e.value=t)}),n(Ve,{onResult:e[16]||(e[16]=t=>ne.value=t),title:"Bitte bestätigen",message:"Soll die ausgewählte Mahlzeit für den Tag gelöscht werden?"})])}}},at=he(it,[["__scopeId","data-v-f6f369f8"]]),ft={__name:"index",setup(ye){return ke(async()=>{ge()}),(A,V)=>(a(),T(at))}};export{ft as default};
