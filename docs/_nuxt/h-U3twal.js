import{I as q,G as fe,C as Be,R as me}from"./ClYbhS5r.js";import{_ as Pe,M as Me,N as pe,O as Ne,J as Ae,P as Ve,K as ge,r as y,o as ke,k as A,g as C,x as p,y as i,z as c,B as n,Q as w,R as d,S as Q,C as s,D as _,A as b,T as X,U as Z,X as W}from"./DvDkmNtn.js";import{I as U}from"./DA__SF9z.js";import{I as Fe}from"./DcIbk8xc.js";import"./jSI97S-j.js";const Oe={class:"text-right mt-3"},We={class:"mt-3"},Le={class:"d-flex flex-column align-center"},He={class:"d-flex flex-column align-center"},Je={class:"mx-3 mt-1",style:{"font-size":"1.6em"}},je={class:"mt-2"},Ke={key:0},Ye={key:1},Ge={class:"ml-1"},qe={key:2,class:"ml-1"},Qe={key:0},Xe={key:1},Ze={key:2},et={key:3,class:"ml-1"},tt={key:0},lt={key:0},ot={key:0},nt={key:1},st={key:0},it={key:1,class:"mt-2"},at={style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em"},class:"pl-1"},ut={key:2},rt=["onClick"],ct={key:2},dt={key:3},vt={class:"mt-5 mb-3"},ft={class:"d-flex flex-column align-center"},mt={class:"mx-3 mt-1",style:{"font-size":"1.6em"}},pt={__name:"MealCalendar",setup(_e){const L=Me(),{recipes:B}=pe(L);Ne(),Ae(),Ve();const I=ge(),{authInfo:x,githubMode:H,lanAddress:he}=pe(I),V=y(""),ee=y(!0),J=y(null),te=y(!1),le=y("");y(null),y(!1);const P=y({}),o=y({}),T=y(0),j=y([]),ye=new Date,E=y([]),F=y({}),De=y(null),oe=y(null);ke(async()=>{console.log("mounted");let l=await I.getAuthInfo();l.icsUrl?(V.value=l.icsUrl,q.fetchIcsData(l.userId,l.icsUrl).then(e=>{setTimeout(()=>{J.value=e.data,$e()},200)})):ee.value=!1,await ae(),ue(),ce()}),A(()=>B.value.filter(l=>!!l.planned));const ne=A(()=>{if(T.value<-1)return"Aktuelle Woche -"+Math.abs(T.value);if(T.value===-1)return"Letzte Woche";if(T.value===0)return"Aktuelle Woche";if(T.value===1)return"Nächste Woche";if(T.value===2)return"Übernächste Woche";if(T.value>2)return"Aktuelle Woche +"+T.value}),we=A(()=>{if(!o.value)return 0;let l=0;console.log("plansByDay",o.value);for(let e=0;e<E.value.length;e++)E.value[e]&&!o.value[E.value[e].iso]&&l++;return l}),K=A(()=>B.value.filter(l=>!!l.planned&&!l.cooked)),Te=A(()=>{const l=new Date,e=l.getFullYear(),m=String(l.getMonth()+1).padStart(2,"0"),v=String(l.getDate()).padStart(2,"0");let a=0;for(const g of Object.keys(o.value)){const h=new Date(g).getFullYear(),r=String(new Date(g).getMonth()+1).padStart(2,"0"),k=String(new Date(g).getDate()).padStart(2,"0");o.value[g]&&!o.value[g].cooked&&o.value[g].type==="RECIPE"&&(new Date(g).getTime()>=l.getTime()||`${h}-${r}-${k}`==`${e}-${m}-${v}`)&&a++}return K.value.length-a});async function Ce(){await q.saveIcsUrl(x.value.userId,V.value),ue()}function se(l){return l?H.value?"https://mmhhhh.de/data/home/recipes/"+l+"/image.jpg":he.value+"api/"+x.value.userId+"/recipes/"+l+"/image":""}async function z(l,e){if(!e){delete o.value[l],M(),await R(),await I.refreshPlannendUntil();return}o.value[l]||(o.value[l]={}),o.value[l].type=e,await R(),await I.refreshPlannendUntil()}function be(l){oe.value().then(e=>{e&&z(l,null)})}async function Se(l,e){if(!e){delete o.value[l],M(),await R(),await I.refreshPlannendUntil();return}for(const v of Object.keys(o.value))o.value[v]&&!o.value[v].cooked&&o.value[v].recipeId===e&&delete o.value[v];o.value[l]||(o.value[l]={});const m=B.value.find(v=>v.id===e);o.value[l].recipeId=e,o.value[l].recipeTitle=m.title,M(),await R(),await I.refreshPlannendUntil()}async function ie(l){H.value?window.open("https://mmhhhh.de/recipes/go?id="+l,"_blank","noopener"):window.open("/recipes/go?id="+l,"_blank","noopener")}async function Y(l){if(o.value[l].recipeId){const e={cooked:!0};await me.updateRecipe(x.value.userId,o.value[l].recipeId,e),await ae(),me.uploadRecipeToGithub(x.value.userId,null)}o.value[l].cooked=!0,await R()}async function ae(){B.value=await L.getAllRecipes(x.value.userId)}async function ue(){let l=await I.getAuthInfo();o.value=l.calendarPlan??{},M()}function M(){j.value=[];for(const l of Object.keys(o.value))o.value[l]&&!o.value[l].cooked&&o.value[l].recipeId&&K.value.map(e=>e.id).includes(o.value[l].recipeId)&&j.value.push(o.value[l].recipeId)}function O(l,e){T.value+=e,M(),l&&window.scrollTo({top:0,behavior:"smooth"}),ce()}async function R(){await q.saveCalendarPlan(x.value.userId,o.value)}function Ie(l){const e=new Date(l),m=e.getDay()||7;return m!==1&&e.setDate(e.getDate()-(m-1)),e.setHours(0,0,0,0),e}function G(l,e){const m=new Date(l);return m.setDate(m.getDate()+e),m}function re(l){const e=l.getFullYear(),m=String(l.getMonth()+1).padStart(2,"0"),v=String(l.getDate()).padStart(2,"0");return`${e}-${m}-${v}`}const ze=new Intl.DateTimeFormat("de-DE",{weekday:"short"}),N=Ie(ye);function ce(){const l=new Date;l.setHours(0,0,0,0),new Date().setHours(23,59,59,0);const m=[];for(let v=T.value*7;v<(T.value+1)*7;v++){const a=G(N,v),g=!(a.getTime()<l.getTime());m.push({date:a,open:g,iso:re(a),weekdayShort:ze.format(a),isBeforeToday:a.getTime()<l.getTime(),isToday:Re(a)})}E.value=m}function Re(l){const e=new Date;return l.getFullYear()===e.getFullYear()&&l.getMonth()===e.getMonth()&&l.getDate()===e.getDate()}function $e(){if(le.value="",!!J.value){te.value=!0;try{const l=J.value,e=U.parse(l),m=new U.Component(e),v=U.Time.fromJSDate(N,!0),a=U.Time.fromJSDate(G(N,21),!0),g=m.getAllSubcomponents("vevent");for(const h of g){const r=new U.Event(h);if(r.startDate)if(r.isRecurring()){const k=new U.RecurExpansion({component:h,dtstart:r.startDate});for(;;){const f=k.next();if(!f||f.compare(a)>=0)break;if(f.compare(v)<0)continue;const S=f;let D;r.duration?(D=S.clone(),D.addDuration(r.duration)):r.endDate?D=r.endDate.clone():D=S.clone(),de(r,S,D)}}else{const k=r.startDate,f=r.endDate||k;f.compare(v)<=0||k.compare(a)>=0||de(r,k,f)}}}catch(l){console.error(l),le.value="Kalender konnte nicht geladen werden. (CORS/URL/Format prüfen)"}finally{te.value=!1}}}function de(l,e,m){const v=e.toJSDate(),a=m.toJSDate(),g=e.isDate,h=new Date(a);g&&h.setDate(h.getDate()-1);const r=N,k=G(N,20),f=v<r?r:v,S=h>k?k:h;for(let D=new Date(f.getFullYear(),f.getMonth(),f.getDate());D<=S;D.setDate(D.getDate()+1)){const $=re(D);P.value[$]||(P.value[$]=[]),P.value[$].push({summary:l.summary,location:l.location,organizer:l.organizer,allDay:g,start:v,end:a})}}function xe(l){if(l.allDay)return"Ganztägig";const e=new Intl.DateTimeFormat("de-DE",{hour:"2-digit",minute:"2-digit"});return`${e.format(l.start)}–${e.format(l.end)}`}return(l,e)=>{const m=C("v-card-title"),v=C("v-text-field"),a=C("v-btn"),g=C("v-card-text"),h=C("v-card"),r=C("v-icon"),k=C("v-row"),f=C("v-col"),S=C("v-img"),D=C("v-alert-title"),$=C("v-alert"),Ee=C("v-divider");return i(),p("div",null,[e[31]||(e[31]=c("h2",{class:"mt-6 text-center"},"Kalender",-1)),c("div",null,[!ee.value&&!Q(H)?(i(),w(h,{key:0,class:"mt-3 mb-4"},{default:s(()=>[n(m,null,{default:s(()=>[...e[9]||(e[9]=[_(" Termine anzeigen ",-1)])]),_:1}),n(g,null,{default:s(()=>[n(v,{modelValue:V.value,"onUpdate:modelValue":e[0]||(e[0]=t=>V.value=t),class:"mt-2","hide-details":"auto",label:"URL zur ics-Datei"},null,8,["modelValue"]),c("div",Oe,[n(a,{variant:"outlined",onClick:Ce},{default:s(()=>[...e[10]||(e[10]=[_("Speichern",-1)])]),_:1})])]),_:1})]),_:1})):d("",!0),c("div",We,[c("div",Le,[c("div",He,[n(h,{class:"pa-2",variant:"elevated"},{default:s(()=>[n(g,null,{default:s(()=>[n(k,null,{default:s(()=>[n(a,{onClick:e[1]||(e[1]=t=>O(!1,-1))},{default:s(()=>[n(r,{icon:"mdi-chevron-left"})]),_:1}),c("div",Je,b(ne.value),1),n(a,{onClick:e[2]||(e[2]=t=>O(!1,1))},{default:s(()=>[n(r,{icon:"mdi-chevron-right"})]),_:1})]),_:1})]),_:1})]),_:1})])]),c("div",je," Offene Tage: "+b(we.value),1)]),(i(!0),p(X,null,Z(E.value,(t,Ue)=>(i(),p("div",{key:t.iso},[n(h,{class:"mt-2",flat:"",color:t.isBeforeToday?"rgb(236,236,236)":t.isToday?"rgb(183, 206, 226)":"white"},{default:s(()=>[n(m,{style:W({color:t.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[o.value[t.iso]?(i(),p("span",Ke,[n(r,{icon:"mdi-check",size:"30",color:"green"})])):d("",!0),o.value[t.iso]?d("",!0):(i(),p("span",Ye,[n(r,{icon:"mdi-close",size:"30",color:"red"})])),c("span",Ge,b(t.weekdayShort)+", "+b(t.date.getDate())+"."+b((t.date.getMonth()+1).toString().padStart(2,"0")),1),!t.open&&t.isBeforeToday&&o.value[t.iso]&&o.value[t.iso].cooked?(i(),p("span",qe,[o.value[t.iso].type==="RECIPE"?(i(),p("span",Qe,[n(r,{icon:"mdi-bowl-mix",size:"30"})])):d("",!0),o.value[t.iso].type==="SCHEDULED"?(i(),p("span",Xe,[n(r,{icon:"mdi-food"})])):d("",!0),o.value[t.iso].type==="OTHER"?(i(),p("span",Ze,[n(r,{icon:"mdi-crosshairs-question"})])):d("",!0),n(a,{variant:"plain",class:"ma-1",onClick:u=>t.open=!0},{default:s(()=>[...e[11]||(e[11]=[_(" Aufklappen ",-1)])]),_:1},8,["onClick"])])):d("",!0),o.value[t.iso]?(i(),p("span",et,[n(a,{variant:"plain",class:"ma-1",onClick:u=>be(t.iso)},{default:s(()=>[...e[12]||(e[12]=[_(" Löschen ",-1)])]),_:1},8,["onClick"])])):d("",!0)]),_:2},1032,["style"]),t.open||t.isBeforeToday&&o.value[t.iso]&&!o.value[t.iso].cooked?(i(),w(g,{key:0,style:{"min-height":"80px"}},{default:s(()=>[n(k,null,{default:s(()=>[n(f,{cols:l.$vuetify.display.mobile?12:4},{default:s(()=>[!t.isBeforeToday&&T.value>=0?(i(),w(h,{key:0,flat:"",color:"white"},{default:s(()=>[n(g,{class:"pa-1",style:W({color:t.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[(i(!0),p(X,null,Z(P.value[t.iso]??[],(u,ve)=>(i(),p("div",{key:ve},[u&&!u.recipe?(i(),p("div",tt,[c("div",null,[c("span",null,[c("b",null,b(xe(u)),1)]),e[13]||(e[13]=_()),c("span",null,b(u.summary||"Ohne Titel"),1)])])):d("",!0)]))),128)),(P.value[t.iso]??[]).length===0?(i(),p("div",lt,"Keine Termine")):d("",!0)]),_:2},1032,["style"])]),_:2},1024)):d("",!0)]),_:2},1032,["cols"]),n(f,null,{default:s(()=>[o.value[t.iso]?d("",!0):(i(),p("div",ot,[c("div",null,[n(a,{"prepend-icon":"mdi-bowl-mix",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:u=>z(t.iso,"RECIPE"),disabled:t.isBeforeToday||Te.value===0},null,8,["onClick","disabled"]),n(a,{"prepend-icon":"mdi-food",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:u=>z(t.iso,"SCHEDULED"),disabled:t.isBeforeToday},null,8,["onClick","disabled"]),n(a,{"prepend-icon":"mdi-crosshairs-question",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:u=>z(t.iso,"OTHER"),disabled:t.isBeforeToday},null,8,["onClick","disabled"])])])),o.value[t.iso]&&o.value[t.iso].type==="RECIPE"?(i(),p("div",nt,[o.value[t.iso].recipeId?d("",!0):(i(),p("div",st,[n(k,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(r,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),n(f,{class:"pl-1 mt-4"},{default:s(()=>[e[16]||(e[16]=_(" Rezept ",-1)),n(a,{variant:"flat",color:o.value[t.iso].recipeId||o.value[t.iso].recipeSelection?"grey":"blue",onClick:u=>o.value[t.iso].recipeSelection=!1,class:"mb-1"},{default:s(()=>[...e[14]||(e[14]=[_("offen lassen",-1)])]),_:1},8,["color","onClick"]),e[17]||(e[17]=_(" oder ",-1)),n(a,{variant:"flat",color:o.value[t.iso].recipeId||o.value[t.iso].recipeSelection?"blue":"grey",onClick:u=>o.value[t.iso].recipeSelection=!0,class:"mb-1"},{default:s(()=>[...e[15]||(e[15]=[_("konkretes Rezept",-1)])]),_:1},8,["color","onClick"]),e[18]||(e[18]=_(" auswählen? ",-1))]),_:2},1024)]),_:2},1024)])),!o.value[t.iso].recipeId&&o.value[t.iso].recipeSelection?(i(),p("div",it,[e[19]||(e[19]=c("h3",null,"Bitte Rezept auswählen:",-1)),n(k,{align:"center"},{default:s(()=>[(i(!0),p(X,null,Z(K.value,u=>(i(),w(f,{key:u.id,cols:"6"},{default:s(()=>[n(h,null,{default:s(()=>[(i(),w(S,{class:"position-relative",height:"100",src:se(u.id),key:F.value[u.id]?F.value[u.id]:0,style:W({opacity:j.value.includes(u.id)?.3:1}),cover:"",onClick:ve=>Se(t.iso,u.id)},null,8,["src","style","onClick"])),c("div",at,b(u.title||"Ohne Titel"),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)])):d("",!0),o.value[t.iso].recipeId?(i(),p("div",ut,[!o.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(i(),w($,{key:0,type:"info",class:"mb-4",color:"rgb(166, 190, 226)"},{default:s(()=>[n(D,{style:{"font-size":"1.3em"}},{default:s(()=>[e[22]||(e[22]=_("Wurde diese Mahlzeit zubereitet? ",-1)),n(a,{variant:"outlined",onClick:u=>Y(t.iso),class:"ml-3"},{default:s(()=>[...e[20]||(e[20]=[_("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?d("",!0):(i(),w(a,{key:0,variant:"outlined",onClick:u=>z(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[21]||(e[21]=[_("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):d("",!0),n(k,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(r,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[(i(),w(S,{class:"position-relative",height:"120",src:se(o.value[t.iso].recipeId),key:F.value[o.value[t.iso].recipeId]?F.value[o.value[t.iso].recipeId]:0,style:W([{opacity:t.isBeforeToday?.6:1},{cursor:"pointer"}]),color:"grey",onClick:u=>ie(o.value[t.iso].recipeId),cover:""},null,8,["src","style","onClick"])),c("div",{style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em",cursor:"pointer"},class:"pl-1",onClick:u=>ie(o.value[t.iso].recipeId)},b(o.value[t.iso].recipeTitle||"Ohne Titel"),9,rt)]),_:2},1024)]),_:2},1024)])):d("",!0)])):d("",!0),o.value[t.iso]&&o.value[t.iso].type==="SCHEDULED"?(i(),p("div",ct,[!o.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(i(),w($,{key:0,type:"info",class:"mb-4",color:"rgb(166, 190, 226)"},{default:s(()=>[n(D,{style:{"font-size":"1.3em"}},{default:s(()=>[e[25]||(e[25]=_("Wurde diese Mahlzeit verzehrt? ",-1)),n(a,{variant:"outlined",onClick:u=>Y(t.iso),class:"ml-3"},{default:s(()=>[...e[23]||(e[23]=[_("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?d("",!0):(i(),w(a,{key:0,variant:"outlined",onClick:u=>z(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[24]||(e[24]=[_("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):d("",!0),n(k,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(r,{icon:"mdi-food",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[c("div",null,[e[26]||(e[26]=c("div",null," Auswärts / Lieferung ",-1)),c("div",null,[n(v,{label:"Notizen (optional)",modelValue:o.value[t.iso].recipeTitle,"onUpdate:modelValue":u=>o.value[t.iso].recipeTitle=u,onKeyup:e[3]||(e[3]=u=>Q(fe).debounceTime("scheduledPlanTitle",R,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):d("",!0),o.value[t.iso]&&o.value[t.iso].type==="OTHER"?(i(),p("div",dt,[!o.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(i(),w($,{key:0,type:"info",class:"mb-2",color:"rgb(166, 190, 226)"},{default:s(()=>[n(D,{style:{"font-size":"1.3em"}},{default:s(()=>[e[29]||(e[29]=_("Wurde diese Mahlzeit verzehrt? ",-1)),n(a,{variant:"outlined",onClick:u=>Y(t.iso),class:"ml-3"},{default:s(()=>[...e[27]||(e[27]=[_("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?d("",!0):(i(),w(a,{key:0,variant:"outlined",onClick:u=>z(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[28]||(e[28]=[_("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):d("",!0),n(k,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(r,{icon:"mdi-crosshairs-question",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"ml-2 pl-1"},{default:s(()=>[c("div",null,[e[30]||(e[30]=c("div",null," Sonstiges ",-1)),c("div",null,[n(v,{label:"Notizen (optional)",modelValue:o.value[t.iso].recipeTitle,"onUpdate:modelValue":u=>o.value[t.iso].recipeTitle=u,onKeyup:e[4]||(e[4]=u=>Q(fe).debounceTime("otherPlanNotes",R,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):d("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)):d("",!0)]),_:2},1032,["color"]),Ue!==E.value.length-1?(i(),w(Ee,{key:0,class:"my-2",opacity:"0.7"})):d("",!0)]))),128)),c("div",vt,[c("div",ft,[n(h,{class:"pa-2",variant:"elevated"},{default:s(()=>[n(g,null,{default:s(()=>[n(k,null,{default:s(()=>[n(a,{onClick:e[5]||(e[5]=t=>O(!0,-1))},{default:s(()=>[n(r,{icon:"mdi-chevron-left"})]),_:1}),c("div",mt,b(ne.value),1),n(a,{onClick:e[6]||(e[6]=t=>O(!0,1))},{default:s(()=>[n(r,{icon:"mdi-chevron-right"})]),_:1})]),_:1})]),_:1})]),_:1})])])]),n(Fe,{onResult:e[7]||(e[7]=t=>De.value=t)}),n(Be,{onResult:e[8]||(e[8]=t=>oe.value=t),title:"Bitte bestätigen",message:"Soll die ausgewählte Mahlzeit für den Tag gelöscht werden?"})])}}},gt=Pe(pt,[["__scopeId","data-v-029a9415"]]),wt={__name:"index",setup(_e){return ke(async()=>{ge()}),(L,B)=>(i(),w(gt))}};export{wt as default};
