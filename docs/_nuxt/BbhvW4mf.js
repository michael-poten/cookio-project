import{_ as Ee,M as Re,N as re,O as ze,J as $e,P as xe,K as de,r as y,o as ce,k as B,g as D,x as p,y as c,z as d,B as l,Q as z,R as w,U as G,C as s,D as h,A as T,S as q,T as Q,Y as M}from"./DVUuHqRB.js";import{I as R}from"./DA__SF9z.js";import{a as X,I as Ue}from"./FPBfI035.js";import{R as Pe}from"./DAjpF4hV.js";import{G as ue}from"./CI608YEO.js";const Ve={class:"text-right mt-3"},Be={class:"mt-3 mb-3"},Ne={class:"d-flex flex-column align-center"},Oe={class:"mt-2"},Fe={key:0},Ae={key:1},He={key:0},Me={key:0},We={key:0},je={key:1},Ke={key:0},Le={style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em"},class:"pl-1"},Ye={key:1},Je=["onClick"],Ge={key:2},qe={key:3},Qe={key:4,class:"mt-1"},Xe={class:"w-100"},Ze={class:"mt-3 mb-3"},et={class:"d-flex flex-column align-center"},tt={__name:"MealCalendar",setup(ve){const W=Re(),{recipes:$}=re(W);ze(),$e(),xe();const C=de(),{authInfo:N,githubMode:j,lanAddress:fe}=re(C),O=y(""),Z=y(!0),K=y(null),ee=y(!1),te=y("");y(null),y(!1);const x=y({}),n=y({}),b=y(0),L=y([]),me=new Date,F=y({}),pe=y(null),ge=y(null);ce(async()=>{console.log("mounted");let t=await C.getAuthInfo();t.icsUrl?(O.value=t.icsUrl,X.fetchIcsData(t.userId,t.icsUrl).then(e=>{K.value=e.data,Ie()})):Z.value=!1,await De(),le()}),B(()=>$.value.filter(t=>!!t.planned));const _e=B(()=>{if(!n.value)return 0;let t=0,e=n.value;new Date().setHours(0,0,0,0);const a=new Date;a.setHours(23,59,59,0);for(let r=b.value*7;r<(b.value+1)*7;r++){const k=P(S,r);if(k.getTime()>a.getTime()){const g=k.getFullYear(),v=String(k.getMonth()+1).padStart(2,"0"),m=String(k.getDate()).padStart(2,"0");(!e[`${g}-${v}-${m}`]||e[`${g}-${v}-${m}`].type==="RECIPE"&&!e[`${g}-${v}-${m}`].recipeId)&&t++}}return t}),Y=B(()=>$.value.filter(t=>!!t.planned&&!t.cooked));async function ye(){await X.saveIcsUrl(N.value.userId,O.value),le()}function oe(t){return t?j.value?"https://mmhhhh.de/data/home/recipes/"+t+"/image.jpg":fe.value+"api/"+N.value.userId+"/recipes/"+t+"/image":""}async function A(t,e){if(!e){delete n.value[t],U(),await E(),await C.refreshPlannendUntil();return}n.value[t]||(n.value[t]={}),n.value[t].type=e,await E(),await C.refreshPlannendUntil()}async function ke(t,e){if(!e){delete n.value[t],U(),await E(),await C.refreshPlannendUntil();return}for(const a of Object.keys(n.value))n.value[a]&&!n.value[a].cooked&&n.value[a].recipeId===e&&delete n.value[a];n.value[t]||(n.value[t]={});const i=$.value.find(a=>a.id===e);n.value[t].recipeId=e,n.value[t].recipeTitle=i.title,U(),await E(),await C.refreshPlannendUntil()}async function ne(t){j.value?window.open("https://mmhhhh.de/recipes/go?id="+t,"_blank","noopener"):window.open("/recipes/go?id="+t,"_blank","noopener")}async function De(){$.value=await W.getAllRecipes(N.value.userId)}async function le(){let t=await C.getAuthInfo();n.value=t.calendarPlan??{},console.log("plansByDay",n.value);for(const e of Object.keys(n.value))n.value[e]&&n.value[e].type==="RECIPE"&&!n.value[e].recipeId&&delete n.value[e];U()}function U(){L.value=[];for(const t of Object.keys(n.value))n.value[t]&&!n.value[t].cooked&&n.value[t].recipeId&&Y.value.map(e=>e.id).includes(n.value[t].recipeId)&&L.value.push(n.value[t].recipeId)}function H(t){U(),t&&window.scrollTo({top:0,behavior:"smooth"})}async function E(){await X.saveCalendarPlan(N.value.userId,n.value)}function we(t){const e=new Date(t),i=e.getDay()||7;return i!==1&&e.setDate(e.getDate()-(i-1)),e.setHours(0,0,0,0),e}function P(t,e){const i=new Date(t);return i.setDate(i.getDate()+e),i}function J(t){const e=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${e}-${i}-${a}`}const se=new Intl.DateTimeFormat("de-DE",{weekday:"short"}),S=we(me),he=B(()=>{const t=new Date;t.setHours(0,0,0,0),new Date().setHours(23,59,59,0);const i=[];for(let a=b.value*7;a<(b.value+1)*7;a++){const r=P(S,a);i.push({date:r,iso:J(r),weekdayShort:se.format(r),isBeforeToday:r.getTime()<t.getTime(),isToday:be(r)})}return i});B(()=>{const t=[];for(let e=0;e<14;e++){const i=P(S,e);t.push({date:i,iso:J(i),weekdayShort:se.format(i)})}return t});function be(t){const e=new Date;return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}function Ie(){if(te.value="",!!K.value){ee.value=!0;try{const t=K.value,e=R.parse(t),i=new R.Component(e),a=R.Time.fromJSDate(S,!0),r=R.Time.fromJSDate(P(S,14),!0),k=i.getAllSubcomponents("vevent");for(const g of k){const v=new R.Event(g);if(v.startDate)if(v.isRecurring()){const m=new R.RecurExpansion({component:g,dtstart:v.startDate});for(;;){const f=m.next();if(!f||f.compare(r)>=0)break;if(f.compare(a)<0)continue;const I=f;let _;v.duration?(_=I.clone(),_.addDuration(v.duration)):v.endDate?_=v.endDate.clone():_=I.clone(),ae(v,I,_)}}else{const m=v.startDate,f=v.endDate||m;f.compare(a)<=0||m.compare(r)>=0||ae(v,m,f)}}}catch(t){console.error(t),te.value="Kalender konnte nicht geladen werden. (CORS/URL/Format prüfen)"}finally{ee.value=!1}}}function ae(t,e,i){const a=e.toJSDate(),r=i.toJSDate(),k=e.isDate,g=new Date(r);k&&g.setDate(g.getDate()-1);const v=S,m=P(S,13),f=a<v?v:a,I=g>m?m:g;for(let _=new Date(f.getFullYear(),f.getMonth(),f.getDate());_<=I;_.setDate(_.getDate()+1)){const V=J(_);x.value[V]||(x.value[V]=[]),x.value[V].push({summary:t.summary,location:t.location,organizer:t.organizer,allDay:k,start:a,end:r})}}function Te(t){if(t.allDay)return"Ganztägig";const e=new Intl.DateTimeFormat("de-DE",{hour:"2-digit",minute:"2-digit"});return`${e.format(t.start)}–${e.format(t.end)}`}return(t,e)=>{const i=D("v-card-title"),a=D("v-text-field"),r=D("v-btn"),k=D("v-card-text"),g=D("v-card"),v=D("v-btn-toggle"),m=D("v-icon"),f=D("v-col"),I=D("v-img"),_=D("v-row"),V=D("v-alert-title"),Ce=D("v-alert"),Se=D("v-divider");return c(),p("div",null,[e[23]||(e[23]=d("h2",{class:"mt-6 text-center"},"Kalender",-1)),d("div",null,[!Z.value&&!G(j)?(c(),z(g,{key:0,class:"mt-3 mb-4"},{default:s(()=>[l(i,null,{default:s(()=>[...e[11]||(e[11]=[h(" Termine anzeigen ",-1)])]),_:1}),l(k,null,{default:s(()=>[l(a,{modelValue:O.value,"onUpdate:modelValue":e[0]||(e[0]=o=>O.value=o),class:"mt-2","hide-details":"auto",label:"URL zur ics-Datei"},null,8,["modelValue"]),d("div",Ve,[l(r,{variant:"outlined",onClick:ye},{default:s(()=>[...e[12]||(e[12]=[h("Speichern",-1)])]),_:1})])]),_:1})]),_:1})):w("",!0),d("div",Be,[d("div",Ne,[l(v,{modelValue:b.value,"onUpdate:modelValue":e[3]||(e[3]=o=>b.value=o),color:"primary",border:"",mandatory:""},{default:s(()=>[l(r,{value:0,style:{"font-size":"0.7em"},onClick:e[1]||(e[1]=o=>H(!1))},{default:s(()=>[...e[13]||(e[13]=[h("Diese Woche",-1)])]),_:1}),l(r,{value:1,style:{"font-size":"0.7em"},onClick:e[2]||(e[2]=o=>H(!1))},{default:s(()=>[...e[14]||(e[14]=[h("Nächste Woche",-1)])]),_:1})]),_:1},8,["modelValue"])]),d("div",Oe," Offene Tage: "+T(_e.value),1)]),(c(!0),p(q,null,Q(he.value,(o,nt)=>(c(),p("div",{key:o.iso},[l(g,{class:"mt-2",flat:"",color:o.isBeforeToday?"rgb(236,236,236)":o.isToday?"rgb(183, 206, 226)":"white"},{default:s(()=>[l(i,{style:M({color:o.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[n.value[o.iso]&&(n.value[o.iso].type==="SCHEDULED"||n.value[o.iso].type==="OTHER"||n.value[o.iso].type==="RECIPE"&&n.value[o.iso].recipeId)?(c(),p("span",Fe,[l(m,{icon:"mdi-check",size:"30",color:"green"})])):w("",!0),!n.value[o.iso]||n.value[o.iso].type==="RECIPE"&&!n.value[o.iso].recipeId?(c(),p("span",Ae,[l(m,{icon:"mdi-close",size:"30",color:"red"})])):w("",!0),h(" "+T(o.weekdayShort)+", "+T(o.date.getDate())+"."+T((o.date.getMonth()+1).toString().padStart(2,"0")),1)]),_:2},1032,["style"]),l(k,{style:{"min-height":"80px"}},{default:s(()=>[l(_,null,{default:s(()=>[l(f,{cols:t.$vuetify.display.mobile?12:4},{default:s(()=>[l(g,{flat:"",color:"white"},{default:s(()=>[l(k,{class:"pa-1",style:M({color:o.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[(c(!0),p(q,null,Q(x.value[o.iso]??[],(u,ie)=>(c(),p("div",{key:ie},[u&&!u.recipe?(c(),p("div",He,[d("div",null,[d("span",null,[d("b",null,T(Te(u)),1)]),e[15]||(e[15]=h()),d("span",null,T(u.summary||"Ohne Titel"),1)])])):w("",!0)]))),128)),(x.value[o.iso]??[]).length===0?(c(),p("div",Me,"Keine Termine")):w("",!0)]),_:2},1032,["style"])]),_:2},1024)]),_:2},1032,["cols"]),l(f,null,{default:s(()=>[n.value[o.iso]?w("",!0):(c(),p("div",We,[d("div",null,[l(r,{"prepend-icon":"mdi-bowl-mix",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:u=>A(o.iso,"RECIPE"),disabled:o.isBeforeToday||Y.value.length===0},null,8,["onClick","disabled"]),l(r,{"prepend-icon":"mdi-calendar-alert",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:u=>A(o.iso,"SCHEDULED"),disabled:o.isBeforeToday},null,8,["onClick","disabled"]),l(r,{"prepend-icon":"mdi-crosshairs-question",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:u=>A(o.iso,"OTHER"),disabled:o.isBeforeToday},null,8,["onClick","disabled"])])])),n.value[o.iso]&&n.value[o.iso].type==="RECIPE"?(c(),p("div",je,[n.value[o.iso].recipeId?w("",!0):(c(),p("div",Ke,[e[16]||(e[16]=d("h3",null,"Bitte Rezept auswählen:",-1)),l(_,{align:"center"},{default:s(()=>[(c(!0),p(q,null,Q(Y.value,u=>(c(),z(f,{key:u.id,cols:"6"},{default:s(()=>[l(g,null,{default:s(()=>[(c(),z(I,{class:"position-relative",height:"100",src:oe(u.id),key:F.value[u.id]?F.value[u.id]:0,style:M({opacity:L.value.includes(u.id)?.3:1}),cover:"",onClick:ie=>ke(o.iso,u.id)},null,8,["src","style","onClick"])),d("div",Le,T(u.title||"Ohne Titel"),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)])),n.value[o.iso].recipeId?(c(),p("div",Ye,[n.value[o.iso].cooked?(c(),z(Ce,{key:0,type:"info",class:"mb-2"},{default:s(()=>[l(V,{style:{"font-size":"1.3em"}},{default:s(()=>[...e[17]||(e[17]=[h("Dieses Gericht wurde bereits zubereitet.",-1)])]),_:1})]),_:1})):w("",!0),l(_,{"no-gutters":""},{default:s(()=>[l(f,{cols:"3"},{default:s(()=>[l(m,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),l(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[(c(),z(I,{class:"position-relative",height:"120",src:oe(n.value[o.iso].recipeId),key:F.value[n.value[o.iso].recipeId]?F.value[n.value[o.iso].recipeId]:0,style:M([{opacity:o.isBeforeToday?.6:1},{cursor:"pointer"}]),color:"grey",onClick:u=>ne(n.value[o.iso].recipeId),cover:""},null,8,["src","style","onClick"])),d("div",{style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em",cursor:"pointer"},class:"pl-1",onClick:u=>ne(n.value[o.iso].recipeId)},T(n.value[o.iso].recipeTitle||"Ohne Titel"),9,Je)]),_:2},1024)]),_:2},1024)])):w("",!0)])):w("",!0),n.value[o.iso]&&n.value[o.iso].type==="SCHEDULED"?(c(),p("div",Ge,[l(_,{"no-gutters":""},{default:s(()=>[l(f,{cols:"3"},{default:s(()=>[l(m,{icon:"mdi-calendar-alert",size:"50"})]),_:1}),l(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[d("div",null,[e[18]||(e[18]=d("div",null," Absprache ",-1)),d("div",null,[l(a,{label:"Notizen (optional)",modelValue:n.value[o.iso].recipeTitle,"onUpdate:modelValue":u=>n.value[o.iso].recipeTitle=u,onKeyup:e[4]||(e[4]=u=>G(ue).debounceTime("scheduledPlanTitle",E,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):w("",!0),n.value[o.iso]&&n.value[o.iso].type==="OTHER"?(c(),p("div",qe,[l(_,{"no-gutters":""},{default:s(()=>[l(f,{cols:"3"},{default:s(()=>[l(m,{icon:"mdi-crosshairs-question",size:"50"})]),_:1}),l(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[d("div",null,[e[19]||(e[19]=d("div",null," Sonstiges ",-1)),d("div",null,[l(a,{label:"Name des Rezepts (optional)",modelValue:n.value[o.iso].recipeTitle,"onUpdate:modelValue":u=>n.value[o.iso].recipeTitle=u,onKeyup:e[5]||(e[5]=u=>G(ue).debounceTime("otherPlanNotes",E,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):w("",!0),n.value[o.iso]?(c(),p("div",Qe,[d("div",Xe,[l(r,{variant:"outlined",class:"ma-1 w-100",onClick:u=>A(o.iso,null)},{default:s(()=>[...e[20]||(e[20]=[h(" Eintrag löschen ",-1)])]),_:1},8,["onClick"])])])):w("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["color"]),l(Se,{class:"my-2",opacity:"0.7"})]))),128)),d("div",Ze,[d("div",et,[l(v,{modelValue:b.value,"onUpdate:modelValue":e[8]||(e[8]=o=>b.value=o),color:"primary",border:"",mandatory:""},{default:s(()=>[l(r,{value:0,style:{"font-size":"0.7em"},onClick:e[6]||(e[6]=o=>H(!0))},{default:s(()=>[...e[21]||(e[21]=[h("Diese Woche",-1)])]),_:1}),l(r,{value:1,style:{"font-size":"0.7em"},onClick:e[7]||(e[7]=o=>H(!0))},{default:s(()=>[...e[22]||(e[22]=[h("Nächste Woche",-1)])]),_:1})]),_:1},8,["modelValue"])])])]),l(Ue,{onResult:e[9]||(e[9]=o=>pe.value=o)}),l(Pe,{onResult:e[10]||(e[10]=o=>ge.value=o)})])}}},ot=Ee(tt,[["__scopeId","data-v-6ef3252d"]]),ut={__name:"index",setup(ve){return ce(async()=>{de()}),(W,$)=>(c(),z(ot))}};export{ut as default};
