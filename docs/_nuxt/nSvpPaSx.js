import{a as q,I as $e,R as ce}from"./CS2M1cia.js";import{_ as xe,M as Ue,N as ve,O as Pe,J as Ve,P as Be,K as me,r as w,o as pe,k as M,g as b,x as p,y as u,z as c,B as n,Q as h,R as _,U as Q,C as s,D as y,A as S,S as X,T as ee,Z as H}from"./CLJmnhjq.js";import{I as x}from"./DA__SF9z.js";import{R as Me}from"./DKQYMiBg.js";import{G as fe}from"./CI608YEO.js";const Oe={class:"text-right mt-3"},Ne={class:"mt-3 mb-3"},Fe={class:"d-flex flex-column align-center"},Ae={class:"mt-2"},He={key:0},je={key:1},Le={key:0},We={key:0},Ke={key:0},Ge={key:1},Je={key:0},Ye={style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em"},class:"pl-1"},Ze={key:1},qe=["onClick"],Qe={key:2},Xe={key:3},et={key:4,class:"mt-1"},tt={class:"w-100"},ot={class:"mt-3 mb-3"},lt={class:"d-flex flex-column align-center"},nt={__name:"MealCalendar",setup(ge){const j=Ue(),{recipes:U}=ve(j);Pe(),Ve(),Be();const z=me(),{authInfo:$,githubMode:L,lanAddress:ke}=ve(z),O=w(""),te=w(!0),W=w(null),oe=w(!1),le=w("");w(null),w(!1);const P=w({}),l=w({}),C=w(0),K=w([]),_e=new Date,N=w({}),ye=w(null),we=w(null);pe(async()=>{console.log("mounted");let t=await z.getAuthInfo();t.icsUrl?(O.value=t.icsUrl,q.fetchIcsData(t.userId,t.icsUrl).then(e=>{setTimeout(()=>{W.value=e.data,ze()},200)})):te.value=!1,await ae(),ie()}),M(()=>U.value.filter(t=>!!t.planned));const De=M(()=>{if(!l.value)return 0;let t=0,e=l.value;new Date().setHours(0,0,0,0);const r=new Date;r.setHours(23,59,59,0);for(let a=C.value*7;a<(C.value+1)*7;a++){const D=B(R,a);if(D.getTime()>r.getTime()){const g=D.getFullYear(),v=String(D.getMonth()+1).padStart(2,"0"),m=String(D.getDate()).padStart(2,"0");(!e[`${g}-${v}-${m}`]||e[`${g}-${v}-${m}`].type==="RECIPE"&&!e[`${g}-${v}-${m}`].recipeId)&&t++}}return t}),G=M(()=>U.value.filter(t=>!!t.planned&&!t.cooked));async function be(){await q.saveIcsUrl($.value.userId,O.value),ie()}function ne(t){return t?L.value?"https://mmhhhh.de/data/home/recipes/"+t+"/image.jpg":ke.value+"api/"+$.value.userId+"/recipes/"+t+"/image":""}async function F(t,e){if(!e){delete l.value[t],V(),await I(),await z.refreshPlannendUntil();return}l.value[t]||(l.value[t]={}),l.value[t].type=e,await I(),await z.refreshPlannendUntil()}async function J(t){l.value[t].cooked=!1,await I()}async function he(t,e){if(!e){delete l.value[t],V(),await I(),await z.refreshPlannendUntil();return}for(const r of Object.keys(l.value))l.value[r]&&!l.value[r].cooked&&l.value[r].recipeId===e&&delete l.value[r];l.value[t]||(l.value[t]={});const d=U.value.find(r=>r.id===e);l.value[t].recipeId=e,l.value[t].recipeTitle=d.title,V(),await I(),await z.refreshPlannendUntil()}async function se(t){L.value?window.open("https://mmhhhh.de/recipes/go?id="+t,"_blank","noopener"):window.open("/recipes/go?id="+t,"_blank","noopener")}async function Ce(t){if(t){const e={cooked:!0};await ce.updateRecipe($.value.userId,t,e),await ae(),ce.uploadRecipeToGithub($.value.userId,null)}for(const e of Object.keys(l.value))l.value[e]&&l.value[e].recipeId===t&&(l.value[e].cooked=!0);await I()}async function ae(){U.value=await j.getAllRecipes($.value.userId)}async function ie(){let t=await z.getAuthInfo();l.value=t.calendarPlan??{},console.log("plansByDay",l.value);for(const e of Object.keys(l.value))l.value[e]&&l.value[e].type==="RECIPE"&&!l.value[e].recipeId&&delete l.value[e];V()}function V(){K.value=[];for(const t of Object.keys(l.value))l.value[t]&&!l.value[t].cooked&&l.value[t].recipeId&&G.value.map(e=>e.id).includes(l.value[t].recipeId)&&K.value.push(l.value[t].recipeId)}function A(t){V(),t&&window.scrollTo({top:0,behavior:"smooth"})}async function I(){await q.saveCalendarPlan($.value.userId,l.value)}function Ie(t){const e=new Date(t),d=e.getDay()||7;return d!==1&&e.setDate(e.getDate()-(d-1)),e.setHours(0,0,0,0),e}function B(t,e){const d=new Date(t);return d.setDate(d.getDate()+e),d}function Y(t){const e=t.getFullYear(),d=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${e}-${d}-${r}`}const re=new Intl.DateTimeFormat("de-DE",{weekday:"short"}),R=Ie(_e),Te=M(()=>{const t=new Date;t.setHours(0,0,0,0),new Date().setHours(23,59,59,0);const d=[];for(let r=C.value*7;r<(C.value+1)*7;r++){const a=B(R,r);d.push({date:a,iso:Y(a),weekdayShort:re.format(a),isBeforeToday:a.getTime()<t.getTime(),isToday:Se(a)})}return d});M(()=>{const t=[];for(let e=0;e<14;e++){const d=B(R,e);t.push({date:d,iso:Y(d),weekdayShort:re.format(d)})}return t});function Se(t){const e=new Date;return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}function ze(){if(le.value="",!!W.value){oe.value=!0;try{const t=W.value,e=x.parse(t),d=new x.Component(e),r=x.Time.fromJSDate(R,!0),a=x.Time.fromJSDate(B(R,14),!0),D=d.getAllSubcomponents("vevent");for(const g of D){const v=new x.Event(g);if(v.startDate)if(v.isRecurring()){const m=new x.RecurExpansion({component:g,dtstart:v.startDate});for(;;){const f=m.next();if(!f||f.compare(a)>=0)break;if(f.compare(r)<0)continue;const T=f;let k;v.duration?(k=T.clone(),k.addDuration(v.duration)):v.endDate?k=v.endDate.clone():k=T.clone(),ue(v,T,k)}}else{const m=v.startDate,f=v.endDate||m;f.compare(r)<=0||m.compare(a)>=0||ue(v,m,f)}}}catch(t){console.error(t),le.value="Kalender konnte nicht geladen werden. (CORS/URL/Format prüfen)"}finally{oe.value=!1}}}function ue(t,e,d){const r=e.toJSDate(),a=d.toJSDate(),D=e.isDate,g=new Date(a);D&&g.setDate(g.getDate()-1);const v=R,m=B(R,13),f=r<v?v:r,T=g>m?m:g;for(let k=new Date(f.getFullYear(),f.getMonth(),f.getDate());k<=T;k.setDate(k.getDate()+1)){const E=Y(k);P.value[E]||(P.value[E]=[]),P.value[E].push({summary:t.summary,location:t.location,organizer:t.organizer,allDay:D,start:r,end:a})}}function Re(t){if(t.allDay)return"Ganztägig";const e=new Intl.DateTimeFormat("de-DE",{hour:"2-digit",minute:"2-digit"});return`${e.format(t.start)}–${e.format(t.end)}`}return(t,e)=>{const d=b("v-card-title"),r=b("v-text-field"),a=b("v-btn"),D=b("v-card-text"),g=b("v-card"),v=b("v-btn-toggle"),m=b("v-icon"),f=b("v-col"),T=b("v-img"),k=b("v-row"),E=b("v-alert-title"),Z=b("v-alert"),Ee=b("v-divider");return u(),p("div",null,[e[29]||(e[29]=c("h2",{class:"mt-6 text-center"},"Kalender",-1)),c("div",null,[!te.value&&!Q(L)?(u(),h(g,{key:0,class:"mt-3 mb-4"},{default:s(()=>[n(d,null,{default:s(()=>[...e[11]||(e[11]=[y(" Termine anzeigen ",-1)])]),_:1}),n(D,null,{default:s(()=>[n(r,{modelValue:O.value,"onUpdate:modelValue":e[0]||(e[0]=o=>O.value=o),class:"mt-2","hide-details":"auto",label:"URL zur ics-Datei"},null,8,["modelValue"]),c("div",Oe,[n(a,{variant:"outlined",onClick:be},{default:s(()=>[...e[12]||(e[12]=[y("Speichern",-1)])]),_:1})])]),_:1})]),_:1})):_("",!0),c("div",Ne,[c("div",Fe,[n(v,{modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=o=>C.value=o),color:"primary",border:"",mandatory:""},{default:s(()=>[n(a,{value:0,style:{"font-size":"0.7em"},onClick:e[1]||(e[1]=o=>A(!1))},{default:s(()=>[...e[13]||(e[13]=[y("Diese Woche",-1)])]),_:1}),n(a,{value:1,style:{"font-size":"0.7em"},onClick:e[2]||(e[2]=o=>A(!1))},{default:s(()=>[...e[14]||(e[14]=[y("Nächste Woche",-1)])]),_:1})]),_:1},8,["modelValue"])]),c("div",Ae," Offene Tage: "+S(De.value),1)]),(u(!0),p(X,null,ee(Te.value,(o,at)=>(u(),p("div",{key:o.iso},[n(g,{class:"mt-2",flat:"",color:o.isBeforeToday?"rgb(236,236,236)":o.isToday?"rgb(183, 206, 226)":"white"},{default:s(()=>[n(d,{style:H({color:o.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[l.value[o.iso]&&(l.value[o.iso].type==="SCHEDULED"||l.value[o.iso].type==="OTHER"||l.value[o.iso].type==="RECIPE"&&l.value[o.iso].recipeId)?(u(),p("span",He,[n(m,{icon:"mdi-check",size:"30",color:"green"})])):_("",!0),!l.value[o.iso]||l.value[o.iso].type==="RECIPE"&&!l.value[o.iso].recipeId?(u(),p("span",je,[n(m,{icon:"mdi-close",size:"30",color:"red"})])):_("",!0),y(" "+S(o.weekdayShort)+", "+S(o.date.getDate())+"."+S((o.date.getMonth()+1).toString().padStart(2,"0")),1)]),_:2},1032,["style"]),n(D,{style:{"min-height":"80px"}},{default:s(()=>[n(k,null,{default:s(()=>[n(f,{cols:t.$vuetify.display.mobile?12:4},{default:s(()=>[n(g,{flat:"",color:"white"},{default:s(()=>[n(D,{class:"pa-1",style:H({color:o.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[(u(!0),p(X,null,ee(P.value[o.iso]??[],(i,de)=>(u(),p("div",{key:de},[i&&!i.recipe?(u(),p("div",Le,[c("div",null,[c("span",null,[c("b",null,S(Re(i)),1)]),e[15]||(e[15]=y()),c("span",null,S(i.summary||"Ohne Titel"),1)])])):_("",!0)]))),128)),(P.value[o.iso]??[]).length===0?(u(),p("div",We,"Keine Termine")):_("",!0)]),_:2},1032,["style"])]),_:2},1024)]),_:2},1032,["cols"]),n(f,null,{default:s(()=>[l.value[o.iso]?_("",!0):(u(),p("div",Ke,[c("div",null,[n(a,{"prepend-icon":"mdi-bowl-mix",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:i=>F(o.iso,"RECIPE"),disabled:o.isBeforeToday||G.value.length===0},null,8,["onClick","disabled"]),n(a,{"prepend-icon":"mdi-food",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:i=>F(o.iso,"SCHEDULED"),disabled:o.isBeforeToday},null,8,["onClick","disabled"]),n(a,{"prepend-icon":"mdi-crosshairs-question",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:i=>F(o.iso,"OTHER"),disabled:o.isBeforeToday},null,8,["onClick","disabled"])])])),l.value[o.iso]&&l.value[o.iso].type==="RECIPE"?(u(),p("div",Ge,[l.value[o.iso].recipeId?_("",!0):(u(),p("div",Je,[e[16]||(e[16]=c("h3",null,"Bitte Rezept auswählen:",-1)),n(k,{align:"center"},{default:s(()=>[(u(!0),p(X,null,ee(G.value,i=>(u(),h(f,{key:i.id,cols:"6"},{default:s(()=>[n(g,null,{default:s(()=>[(u(),h(T,{class:"position-relative",height:"100",src:ne(i.id),key:N.value[i.id]?N.value[i.id]:0,style:H({opacity:K.value.includes(i.id)?.3:1}),cover:"",onClick:de=>he(o.iso,i.id)},null,8,["src","style","onClick"])),c("div",Ye,S(i.title||"Ohne Titel"),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)])),l.value[o.iso].recipeId?(u(),p("div",Ze,[l.value[o.iso].cooked?(u(),h(Z,{key:0,type:"info",class:"mb-2"},{default:s(()=>[n(E,{style:{"font-size":"1.3em"}},{default:s(()=>[e[18]||(e[18]=y("Dieses Gericht wurde bereits zubereitet.",-1)),n(a,{variant:"plain",onClick:i=>J(o.iso)},{default:s(()=>[...e[17]||(e[17]=[y("Zurücksetzen",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1024)):_("",!0),n(k,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(m,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[(u(),h(T,{class:"position-relative",height:"120",src:ne(l.value[o.iso].recipeId),key:N.value[l.value[o.iso].recipeId]?N.value[l.value[o.iso].recipeId]:0,style:H([{opacity:o.isBeforeToday?.6:1},{cursor:"pointer"}]),color:"grey",onClick:i=>se(l.value[o.iso].recipeId),cover:""},null,8,["src","style","onClick"])),c("div",{style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em",cursor:"pointer"},class:"pl-1",onClick:i=>se(l.value[o.iso].recipeId)},S(l.value[o.iso].recipeTitle||"Ohne Titel"),9,qe)]),_:2},1024)]),_:2},1024)])):_("",!0)])):_("",!0),l.value[o.iso]&&l.value[o.iso].type==="SCHEDULED"?(u(),p("div",Qe,[l.value[o.iso].cooked?(u(),h(Z,{key:0,type:"info",class:"mb-2"},{default:s(()=>[n(E,{style:{"font-size":"1.3em"}},{default:s(()=>[e[20]||(e[20]=y("Diese Mahlzeit wurde bereits verzehrt.",-1)),n(a,{variant:"plain",onClick:i=>J(o.iso)},{default:s(()=>[...e[19]||(e[19]=[y("Zurücksetzen",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1024)):_("",!0),n(k,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(m,{icon:"mdi-food",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[c("div",null,[e[21]||(e[21]=c("div",null," Auswärts / Lieferung / Verzehrfertig ",-1)),c("div",null,[n(r,{label:"Notizen (optional)",modelValue:l.value[o.iso].recipeTitle,"onUpdate:modelValue":i=>l.value[o.iso].recipeTitle=i,onKeyup:e[4]||(e[4]=i=>Q(fe).debounceTime("scheduledPlanTitle",I,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):_("",!0),l.value[o.iso]&&l.value[o.iso].type==="OTHER"?(u(),p("div",Xe,[l.value[o.iso].cooked?(u(),h(Z,{key:0,type:"info",class:"mb-2"},{default:s(()=>[n(E,{style:{"font-size":"1.3em"}},{default:s(()=>[e[23]||(e[23]=y("Diese Mahlzeit wurde bereits verzehrt.",-1)),n(a,{variant:"plain",onClick:i=>J(o.iso)},{default:s(()=>[...e[22]||(e[22]=[y("Zurücksetzen",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1024)):_("",!0),n(k,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(m,{icon:"mdi-crosshairs-question",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[c("div",null,[e[24]||(e[24]=c("div",null," Sonstiges ",-1)),c("div",null,[n(r,{label:"Name des Rezepts (optional)",modelValue:l.value[o.iso].recipeTitle,"onUpdate:modelValue":i=>l.value[o.iso].recipeTitle=i,onKeyup:e[5]||(e[5]=i=>Q(fe).debounceTime("otherPlanNotes",I,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):_("",!0),l.value[o.iso]?(u(),p("div",et,[c("div",tt,[n(a,{variant:"outlined",class:"ma-1 w-100",color:"red",onClick:i=>F(o.iso,null)},{default:s(()=>[...e[25]||(e[25]=[y(" Eintrag löschen ",-1)])]),_:1},8,["onClick"]),o.isBeforeToday&&!l.value[o.iso].cooked?(u(),h(a,{key:0,variant:"outlined",class:"ma-1 w-100",onClick:i=>Ce(l.value[o.iso].recipeId)},{default:s(()=>[...e[26]||(e[26]=[y(" Mahlzeit wurde verzehrt ",-1)])]),_:1},8,["onClick"])):_("",!0)])])):_("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["color"]),n(Ee,{class:"my-2",opacity:"0.7"})]))),128)),c("div",ot,[c("div",lt,[n(v,{modelValue:C.value,"onUpdate:modelValue":e[8]||(e[8]=o=>C.value=o),color:"primary",border:"",mandatory:""},{default:s(()=>[n(a,{value:0,style:{"font-size":"0.7em"},onClick:e[6]||(e[6]=o=>A(!0))},{default:s(()=>[...e[27]||(e[27]=[y("Diese Woche",-1)])]),_:1}),n(a,{value:1,style:{"font-size":"0.7em"},onClick:e[7]||(e[7]=o=>A(!0))},{default:s(()=>[...e[28]||(e[28]=[y("Nächste Woche",-1)])]),_:1})]),_:1},8,["modelValue"])])])]),n($e,{onResult:e[9]||(e[9]=o=>ye.value=o)}),n(Me,{onResult:e[10]||(e[10]=o=>we.value=o)})])}}},st=xe(nt,[["__scopeId","data-v-879868ab"]]),vt={__name:"index",setup(ge){return pe(async()=>{me()}),(j,U)=>(u(),h(st))}};export{vt as default};
