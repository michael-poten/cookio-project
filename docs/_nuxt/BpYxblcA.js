import{a as q,I as Ee,R as de}from"./CPDuH1MZ.js";import{_ as $e,M as xe,N as ce,O as Ue,J as Pe,P as Ve,K as fe,r as y,o as me,k as M,g as D,x as p,y as r,z as c,B as n,Q as b,R as k,U as Q,C as s,D as h,A as C,S as Z,T as X,Z as H}from"./D1-lrkTr.js";import{I as x}from"./DA__SF9z.js";import{R as Be}from"./pPtDuf-a.js";import{G as ve}from"./CI608YEO.js";const Me={class:"text-right mt-3"},Oe={class:"mt-3 mb-3"},Ne={class:"d-flex flex-column align-center"},Fe={class:"mt-2"},Ae={key:0},He={key:1},je={key:0},Le={key:0},We={key:0},Ke={key:1},Ge={key:0},Je={style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em"},class:"pl-1"},Ye={key:1},qe=["onClick"],Qe={key:2},Ze={key:3},Xe={key:4,class:"mt-1"},et={class:"w-100"},tt={class:"mt-3 mb-3"},ot={class:"d-flex flex-column align-center"},lt={__name:"MealCalendar",setup(pe){const j=xe(),{recipes:U}=ce(j);Ue(),Pe(),Ve();const S=fe(),{authInfo:$,githubMode:L,lanAddress:ge}=ce(S),O=y(""),ee=y(!0),W=y(null),te=y(!1),oe=y("");y(null),y(!1);const P=y({}),o=y({}),I=y(0),K=y([]),_e=new Date,N=y({}),ke=y(null),ye=y(null);me(async()=>{console.log("mounted");let t=await S.getAuthInfo();t.icsUrl?(O.value=t.icsUrl,q.fetchIcsData(t.userId,t.icsUrl).then(e=>{setTimeout(()=>{W.value=e.data,Se()},200)})):ee.value=!1,await se(),ae()}),M(()=>U.value.filter(t=>!!t.planned));const we=M(()=>{if(!o.value)return 0;let t=0,e=o.value;new Date().setHours(0,0,0,0);const a=new Date;a.setHours(23,59,59,0);for(let i=I.value*7;i<(I.value+1)*7;i++){const w=B(z,i);if(w.getTime()>a.getTime()){const g=w.getFullYear(),v=String(w.getMonth()+1).padStart(2,"0"),m=String(w.getDate()).padStart(2,"0");(!e[`${g}-${v}-${m}`]||e[`${g}-${v}-${m}`].type==="RECIPE"&&!e[`${g}-${v}-${m}`].recipeId)&&t++}}return t}),G=M(()=>U.value.filter(t=>!!t.planned&&!t.cooked));async function De(){await q.saveIcsUrl($.value.userId,O.value),ae()}function le(t){return t?L.value?"https://mmhhhh.de/data/home/recipes/"+t+"/image.jpg":ge.value+"api/"+$.value.userId+"/recipes/"+t+"/image":""}async function F(t,e){if(!e){delete o.value[t],V(),await R(),await S.refreshPlannendUntil();return}o.value[t]||(o.value[t]={}),o.value[t].type=e,await R(),await S.refreshPlannendUntil()}async function he(t,e){if(!e){delete o.value[t],V(),await R(),await S.refreshPlannendUntil();return}for(const a of Object.keys(o.value))o.value[a]&&!o.value[a].cooked&&o.value[a].recipeId===e&&delete o.value[a];o.value[t]||(o.value[t]={});const u=U.value.find(a=>a.id===e);o.value[t].recipeId=e,o.value[t].recipeTitle=u.title,V(),await R(),await S.refreshPlannendUntil()}async function ne(t){L.value?window.open("https://mmhhhh.de/recipes/go?id="+t,"_blank","noopener"):window.open("/recipes/go?id="+t,"_blank","noopener")}async function be(t){if(t){const e={cooked:!0};await de.updateRecipe($.value.userId,t,e),await se(),de.uploadRecipeToGithub($.value.userId,null)}for(const e of Object.keys(o.value))o.value[e]&&o.value[e].recipeId===t&&(o.value[e].cooked=!0);await R()}async function se(){U.value=await j.getAllRecipes($.value.userId)}async function ae(){let t=await S.getAuthInfo();o.value=t.calendarPlan??{},console.log("plansByDay",o.value);for(const e of Object.keys(o.value))o.value[e]&&o.value[e].type==="RECIPE"&&!o.value[e].recipeId&&delete o.value[e];V()}function V(){K.value=[];for(const t of Object.keys(o.value))o.value[t]&&!o.value[t].cooked&&o.value[t].recipeId&&G.value.map(e=>e.id).includes(o.value[t].recipeId)&&K.value.push(o.value[t].recipeId)}function A(t){V(),t&&window.scrollTo({top:0,behavior:"smooth"})}async function R(){await q.saveCalendarPlan($.value.userId,o.value)}function Ie(t){const e=new Date(t),u=e.getDay()||7;return u!==1&&e.setDate(e.getDate()-(u-1)),e.setHours(0,0,0,0),e}function B(t,e){const u=new Date(t);return u.setDate(u.getDate()+e),u}function J(t){const e=t.getFullYear(),u=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${e}-${u}-${a}`}const ie=new Intl.DateTimeFormat("de-DE",{weekday:"short"}),z=Ie(_e),Te=M(()=>{const t=new Date;t.setHours(0,0,0,0),new Date().setHours(23,59,59,0);const u=[];for(let a=I.value*7;a<(I.value+1)*7;a++){const i=B(z,a);u.push({date:i,iso:J(i),weekdayShort:ie.format(i),isBeforeToday:i.getTime()<t.getTime(),isToday:Ce(i)})}return u});M(()=>{const t=[];for(let e=0;e<14;e++){const u=B(z,e);t.push({date:u,iso:J(u),weekdayShort:ie.format(u)})}return t});function Ce(t){const e=new Date;return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}function Se(){if(oe.value="",!!W.value){te.value=!0;try{const t=W.value,e=x.parse(t),u=new x.Component(e),a=x.Time.fromJSDate(z,!0),i=x.Time.fromJSDate(B(z,14),!0),w=u.getAllSubcomponents("vevent");for(const g of w){const v=new x.Event(g);if(v.startDate)if(v.isRecurring()){const m=new x.RecurExpansion({component:g,dtstart:v.startDate});for(;;){const f=m.next();if(!f||f.compare(i)>=0)break;if(f.compare(a)<0)continue;const T=f;let _;v.duration?(_=T.clone(),_.addDuration(v.duration)):v.endDate?_=v.endDate.clone():_=T.clone(),re(v,T,_)}}else{const m=v.startDate,f=v.endDate||m;f.compare(a)<=0||m.compare(i)>=0||re(v,m,f)}}}catch(t){console.error(t),oe.value="Kalender konnte nicht geladen werden. (CORS/URL/Format prüfen)"}finally{te.value=!1}}}function re(t,e,u){const a=e.toJSDate(),i=u.toJSDate(),w=e.isDate,g=new Date(i);w&&g.setDate(g.getDate()-1);const v=z,m=B(z,13),f=a<v?v:a,T=g>m?m:g;for(let _=new Date(f.getFullYear(),f.getMonth(),f.getDate());_<=T;_.setDate(_.getDate()+1)){const E=J(_);P.value[E]||(P.value[E]=[]),P.value[E].push({summary:t.summary,location:t.location,organizer:t.organizer,allDay:w,start:a,end:i})}}function Re(t){if(t.allDay)return"Ganztägig";const e=new Intl.DateTimeFormat("de-DE",{hour:"2-digit",minute:"2-digit"});return`${e.format(t.start)}–${e.format(t.end)}`}return(t,e)=>{const u=D("v-card-title"),a=D("v-text-field"),i=D("v-btn"),w=D("v-card-text"),g=D("v-card"),v=D("v-btn-toggle"),m=D("v-icon"),f=D("v-col"),T=D("v-img"),_=D("v-row"),E=D("v-alert-title"),Y=D("v-alert"),ze=D("v-divider");return r(),p("div",null,[e[26]||(e[26]=c("h2",{class:"mt-6 text-center"},"Kalender",-1)),c("div",null,[!ee.value&&!Q(L)?(r(),b(g,{key:0,class:"mt-3 mb-4"},{default:s(()=>[n(u,null,{default:s(()=>[...e[11]||(e[11]=[h(" Termine anzeigen ",-1)])]),_:1}),n(w,null,{default:s(()=>[n(a,{modelValue:O.value,"onUpdate:modelValue":e[0]||(e[0]=l=>O.value=l),class:"mt-2","hide-details":"auto",label:"URL zur ics-Datei"},null,8,["modelValue"]),c("div",Me,[n(i,{variant:"outlined",onClick:De},{default:s(()=>[...e[12]||(e[12]=[h("Speichern",-1)])]),_:1})])]),_:1})]),_:1})):k("",!0),c("div",Oe,[c("div",Ne,[n(v,{modelValue:I.value,"onUpdate:modelValue":e[3]||(e[3]=l=>I.value=l),color:"primary",border:"",mandatory:""},{default:s(()=>[n(i,{value:0,style:{"font-size":"0.7em"},onClick:e[1]||(e[1]=l=>A(!1))},{default:s(()=>[...e[13]||(e[13]=[h("Diese Woche",-1)])]),_:1}),n(i,{value:1,style:{"font-size":"0.7em"},onClick:e[2]||(e[2]=l=>A(!1))},{default:s(()=>[...e[14]||(e[14]=[h("Nächste Woche",-1)])]),_:1})]),_:1},8,["modelValue"])]),c("div",Fe," Offene Tage: "+C(we.value),1)]),(r(!0),p(Z,null,X(Te.value,(l,st)=>(r(),p("div",{key:l.iso},[n(g,{class:"mt-2",flat:"",color:l.isBeforeToday?"rgb(236,236,236)":l.isToday?"rgb(183, 206, 226)":"white"},{default:s(()=>[n(u,{style:H({color:l.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[o.value[l.iso]&&(o.value[l.iso].type==="SCHEDULED"||o.value[l.iso].type==="OTHER"||o.value[l.iso].type==="RECIPE"&&o.value[l.iso].recipeId)?(r(),p("span",Ae,[n(m,{icon:"mdi-check",size:"30",color:"green"})])):k("",!0),!o.value[l.iso]||o.value[l.iso].type==="RECIPE"&&!o.value[l.iso].recipeId?(r(),p("span",He,[n(m,{icon:"mdi-close",size:"30",color:"red"})])):k("",!0),h(" "+C(l.weekdayShort)+", "+C(l.date.getDate())+"."+C((l.date.getMonth()+1).toString().padStart(2,"0")),1)]),_:2},1032,["style"]),n(w,{style:{"min-height":"80px"}},{default:s(()=>[n(_,null,{default:s(()=>[n(f,{cols:t.$vuetify.display.mobile?12:4},{default:s(()=>[n(g,{flat:"",color:"white"},{default:s(()=>[n(w,{class:"pa-1",style:H({color:l.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[(r(!0),p(Z,null,X(P.value[l.iso]??[],(d,ue)=>(r(),p("div",{key:ue},[d&&!d.recipe?(r(),p("div",je,[c("div",null,[c("span",null,[c("b",null,C(Re(d)),1)]),e[15]||(e[15]=h()),c("span",null,C(d.summary||"Ohne Titel"),1)])])):k("",!0)]))),128)),(P.value[l.iso]??[]).length===0?(r(),p("div",Le,"Keine Termine")):k("",!0)]),_:2},1032,["style"])]),_:2},1024)]),_:2},1032,["cols"]),n(f,null,{default:s(()=>[o.value[l.iso]?k("",!0):(r(),p("div",We,[c("div",null,[n(i,{"prepend-icon":"mdi-bowl-mix",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:d=>F(l.iso,"RECIPE"),disabled:l.isBeforeToday||G.value.length===0},null,8,["onClick","disabled"]),n(i,{"prepend-icon":"mdi-food",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:d=>F(l.iso,"SCHEDULED"),disabled:l.isBeforeToday},null,8,["onClick","disabled"]),n(i,{"prepend-icon":"mdi-crosshairs-question",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:d=>F(l.iso,"OTHER"),disabled:l.isBeforeToday},null,8,["onClick","disabled"])])])),o.value[l.iso]&&o.value[l.iso].type==="RECIPE"?(r(),p("div",Ke,[o.value[l.iso].recipeId?k("",!0):(r(),p("div",Ge,[e[16]||(e[16]=c("h3",null,"Bitte Rezept auswählen:",-1)),n(_,{align:"center"},{default:s(()=>[(r(!0),p(Z,null,X(G.value,d=>(r(),b(f,{key:d.id,cols:"6"},{default:s(()=>[n(g,null,{default:s(()=>[(r(),b(T,{class:"position-relative",height:"100",src:le(d.id),key:N.value[d.id]?N.value[d.id]:0,style:H({opacity:K.value.includes(d.id)?.3:1}),cover:"",onClick:ue=>he(l.iso,d.id)},null,8,["src","style","onClick"])),c("div",Je,C(d.title||"Ohne Titel"),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)])),o.value[l.iso].recipeId?(r(),p("div",Ye,[o.value[l.iso].cooked?(r(),b(Y,{key:0,type:"info",class:"mb-2"},{default:s(()=>[n(E,{style:{"font-size":"1.3em"}},{default:s(()=>[...e[17]||(e[17]=[h("Dieses Gericht wurde bereits zubereitet.",-1)])]),_:1})]),_:1})):k("",!0),n(_,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(m,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[(r(),b(T,{class:"position-relative",height:"120",src:le(o.value[l.iso].recipeId),key:N.value[o.value[l.iso].recipeId]?N.value[o.value[l.iso].recipeId]:0,style:H([{opacity:l.isBeforeToday?.6:1},{cursor:"pointer"}]),color:"grey",onClick:d=>ne(o.value[l.iso].recipeId),cover:""},null,8,["src","style","onClick"])),c("div",{style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em",cursor:"pointer"},class:"pl-1",onClick:d=>ne(o.value[l.iso].recipeId)},C(o.value[l.iso].recipeTitle||"Ohne Titel"),9,qe)]),_:2},1024)]),_:2},1024)])):k("",!0)])):k("",!0),o.value[l.iso]&&o.value[l.iso].type==="SCHEDULED"?(r(),p("div",Qe,[o.value[l.iso].cooked?(r(),b(Y,{key:0,type:"info",class:"mb-2"},{default:s(()=>[n(E,{style:{"font-size":"1.3em"}},{default:s(()=>[...e[18]||(e[18]=[h("Diese Mahlzeit wurde bereits verzehrt.",-1)])]),_:1})]),_:1})):k("",!0),n(_,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(m,{icon:"mdi-food",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[c("div",null,[e[19]||(e[19]=c("div",null," Auswärts / Lieferung / Verzehrfertig ",-1)),c("div",null,[n(a,{label:"Notizen (optional)",modelValue:o.value[l.iso].recipeTitle,"onUpdate:modelValue":d=>o.value[l.iso].recipeTitle=d,onKeyup:e[4]||(e[4]=d=>Q(ve).debounceTime("scheduledPlanTitle",R,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):k("",!0),o.value[l.iso]&&o.value[l.iso].type==="OTHER"?(r(),p("div",Ze,[o.value[l.iso].cooked?(r(),b(Y,{key:0,type:"info",class:"mb-2"},{default:s(()=>[n(E,{style:{"font-size":"1.3em"}},{default:s(()=>[...e[20]||(e[20]=[h("Diese Mahlzeit wurde bereits verzehrt.",-1)])]),_:1})]),_:1})):k("",!0),n(_,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(m,{icon:"mdi-crosshairs-question",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[c("div",null,[e[21]||(e[21]=c("div",null," Sonstiges ",-1)),c("div",null,[n(a,{label:"Name des Rezepts (optional)",modelValue:o.value[l.iso].recipeTitle,"onUpdate:modelValue":d=>o.value[l.iso].recipeTitle=d,onKeyup:e[5]||(e[5]=d=>Q(ve).debounceTime("otherPlanNotes",R,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):k("",!0),o.value[l.iso]?(r(),p("div",Xe,[c("div",et,[n(i,{variant:"outlined",class:"ma-1 w-100",color:"red",onClick:d=>F(l.iso,null)},{default:s(()=>[...e[22]||(e[22]=[h(" Eintrag löschen ",-1)])]),_:1},8,["onClick"]),l.isBeforeToday&&!o.value[l.iso].cooked?(r(),b(i,{key:0,variant:"outlined",class:"ma-1 w-100",onClick:d=>be(o.value[l.iso].recipeId)},{default:s(()=>[...e[23]||(e[23]=[h(" Mahlzeit wurde verzehrt ",-1)])]),_:1},8,["onClick"])):k("",!0)])])):k("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["color"]),n(ze,{class:"my-2",opacity:"0.7"})]))),128)),c("div",tt,[c("div",ot,[n(v,{modelValue:I.value,"onUpdate:modelValue":e[8]||(e[8]=l=>I.value=l),color:"primary",border:"",mandatory:""},{default:s(()=>[n(i,{value:0,style:{"font-size":"0.7em"},onClick:e[6]||(e[6]=l=>A(!0))},{default:s(()=>[...e[24]||(e[24]=[h("Diese Woche",-1)])]),_:1}),n(i,{value:1,style:{"font-size":"0.7em"},onClick:e[7]||(e[7]=l=>A(!0))},{default:s(()=>[...e[25]||(e[25]=[h("Nächste Woche",-1)])]),_:1})]),_:1},8,["modelValue"])])])]),n(Ee,{onResult:e[9]||(e[9]=l=>ke.value=l)}),n(Be,{onResult:e[10]||(e[10]=l=>ye.value=l)})])}}},nt=$e(lt,[["__scopeId","data-v-95bb8153"]]),ct={__name:"index",setup(pe){return me(async()=>{fe()}),(j,U)=>(r(),b(nt))}};export{ct as default};
