import{I as q,C as Be,R as fe}from"./DNpDl8al.js";import{_ as Pe,M as Ae,N as me,O as Me,J as Ne,P as Ve,K as ge,r as w,o as ke,k as M,g as T,x as m,y as i,z as d,B as n,Q as C,R as v,U as Q,C as s,D as k,A as b,S as X,T as Z,a3 as F}from"./De8V3zEY.js";import{I as U}from"./DA__SF9z.js";import{I as Oe}from"./BO5j8faj.js";import"./C6XZ8dUp.js";import{G as pe}from"./CI608YEO.js";const We={class:"text-right mt-3"},Fe={class:"mt-3"},He={class:"d-flex flex-column align-center"},Le={class:"d-flex flex-column align-center"},Je={class:"mx-3 mt-1",style:{"font-size":"1.6em"}},je={class:"mt-2"},Ke={key:0},Ye={key:1},Ge={class:"ml-2"},qe={key:2},Qe={key:3,class:"ml-2"},Xe={key:0},Ze={key:1},et={key:2},tt={key:0},ot={key:0},lt={key:0},nt={key:1},st={key:0},it={key:1,class:"mt-2"},at={style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em"},class:"pl-1"},rt={key:2},ut=["onClick"],ct={key:2},dt={key:3},vt={class:"mt-5 mb-3"},ft={class:"d-flex flex-column align-center"},mt={class:"mx-3 mt-1",style:{"font-size":"1.6em"}},pt={__name:"MealCalendar",setup(_e){const H=Ae(),{recipes:B}=me(H);Me(),Ne(),Ve();const I=ge(),{authInfo:E,githubMode:L,lanAddress:he}=me(I),N=w(""),ee=w(!0),J=w(null),te=w(!1),oe=w("");w(null),w(!1);const P=w({}),l=w({}),y=w(0),j=w([]),we=new Date,K=w([]),V=w({}),ye=w(null),le=w(null);ke(async()=>{console.log("mounted");let o=await I.getAuthInfo();o.icsUrl?(N.value=o.icsUrl,q.fetchIcsData(o.userId,o.icsUrl).then(e=>{setTimeout(()=>{J.value=e.data,xe()},200)})):ee.value=!1,await ae(),re(),ce()}),M(()=>B.value.filter(o=>!!o.planned));const ne=M(()=>{if(y.value<-1)return"Aktuelle Woche -"+Math.abs(y.value);if(y.value===-1)return"Letzte Woche";if(y.value===0)return"Aktuelle Woche";if(y.value===1)return"Nächste Woche";if(y.value===2)return"Übernächste Woche";if(y.value>2)return"Aktuelle Woche +"+y.value}),De=M(()=>{if(!l.value)return 0;let o=0,e=l.value;new Date().setHours(0,0,0,0);const c=new Date;c.setHours(23,59,59,0);for(let a=y.value*7;a<(y.value+1)*7;a++){const _=W($,a);if(_.getTime()>c.getTime()){const h=_.getFullYear(),u=String(_.getMonth()+1).padStart(2,"0"),g=String(_.getDate()).padStart(2,"0");e[`${h}-${u}-${g}`]||o++}}return o}),Y=M(()=>B.value.filter(o=>!!o.planned&&!o.cooked)),Ce=M(()=>{let o=0;for(const e of Object.keys(l.value))l.value[e]&&!l.value[e].cooked&&l.value[e].type==="RECIPE"&&o++;return o-Y.value.length});async function Te(){await q.saveIcsUrl(E.value.userId,N.value),re()}function se(o){return o?L.value?"https://mmhhhh.de/data/home/recipes/"+o+"/image.jpg":he.value+"api/"+E.value.userId+"/recipes/"+o+"/image":""}async function z(o,e){if(!e){delete l.value[o],A(),await R(),await I.refreshPlannendUntil();return}l.value[o]||(l.value[o]={}),l.value[o].type=e,await R(),await I.refreshPlannendUntil()}function be(o){le.value().then(e=>{e&&z(o,null)})}async function Se(o,e){if(!e){delete l.value[o],A(),await R(),await I.refreshPlannendUntil();return}for(const c of Object.keys(l.value))l.value[c]&&!l.value[c].cooked&&l.value[c].recipeId===e&&delete l.value[c];l.value[o]||(l.value[o]={});const p=B.value.find(c=>c.id===e);l.value[o].recipeId=e,l.value[o].recipeTitle=p.title,A(),await R(),await I.refreshPlannendUntil()}async function ie(o){L.value?window.open("https://mmhhhh.de/recipes/go?id="+o,"_blank","noopener"):window.open("/recipes/go?id="+o,"_blank","noopener")}async function G(o){if(l.value[o].recipeId){const e={cooked:!0};await fe.updateRecipe(E.value.userId,l.value[o].recipeId,e),await ae(),fe.uploadRecipeToGithub(E.value.userId,null)}l.value[o].cooked=!0,await R()}async function ae(){B.value=await H.getAllRecipes(E.value.userId)}async function re(){let o=await I.getAuthInfo();l.value=o.calendarPlan??{},A()}function A(){j.value=[];for(const o of Object.keys(l.value))l.value[o]&&!l.value[o].cooked&&l.value[o].recipeId&&Y.value.map(e=>e.id).includes(l.value[o].recipeId)&&j.value.push(l.value[o].recipeId)}function O(o,e){y.value+=e,A(),o&&window.scrollTo({top:0,behavior:"smooth"}),ce()}async function R(){await q.saveCalendarPlan(E.value.userId,l.value)}function Ie(o){const e=new Date(o),p=e.getDay()||7;return p!==1&&e.setDate(e.getDate()-(p-1)),e.setHours(0,0,0,0),e}function W(o,e){const p=new Date(o);return p.setDate(p.getDate()+e),p}function ue(o){const e=o.getFullYear(),p=String(o.getMonth()+1).padStart(2,"0"),c=String(o.getDate()).padStart(2,"0");return`${e}-${p}-${c}`}const ze=new Intl.DateTimeFormat("de-DE",{weekday:"short"}),$=Ie(we);function ce(){const o=new Date;o.setHours(0,0,0,0),new Date().setHours(23,59,59,0);const p=[];for(let c=y.value*7;c<(y.value+1)*7;c++){const a=W($,c),_=!(a.getTime()<o.getTime());p.push({date:a,open:_,iso:ue(a),weekdayShort:ze.format(a),isBeforeToday:a.getTime()<o.getTime(),isToday:Re(a)})}K.value=p}function Re(o){const e=new Date;return o.getFullYear()===e.getFullYear()&&o.getMonth()===e.getMonth()&&o.getDate()===e.getDate()}function xe(){if(oe.value="",!!J.value){te.value=!0;try{const o=J.value,e=U.parse(o),p=new U.Component(e),c=U.Time.fromJSDate($,!0),a=U.Time.fromJSDate(W($,21),!0),_=p.getAllSubcomponents("vevent");for(const h of _){const u=new U.Event(h);if(u.startDate)if(u.isRecurring()){const g=new U.RecurExpansion({component:h,dtstart:u.startDate});for(;;){const f=g.next();if(!f||f.compare(a)>=0)break;if(f.compare(c)<0)continue;const S=f;let D;u.duration?(D=S.clone(),D.addDuration(u.duration)):u.endDate?D=u.endDate.clone():D=S.clone(),de(u,S,D)}}else{const g=u.startDate,f=u.endDate||g;f.compare(c)<=0||g.compare(a)>=0||de(u,g,f)}}}catch(o){console.error(o),oe.value="Kalender konnte nicht geladen werden. (CORS/URL/Format prüfen)"}finally{te.value=!1}}}function de(o,e,p){const c=e.toJSDate(),a=p.toJSDate(),_=e.isDate,h=new Date(a);_&&h.setDate(h.getDate()-1);const u=$,g=W($,20),f=c<u?u:c,S=h>g?g:h;for(let D=new Date(f.getFullYear(),f.getMonth(),f.getDate());D<=S;D.setDate(D.getDate()+1)){const x=ue(D);P.value[x]||(P.value[x]=[]),P.value[x].push({summary:o.summary,location:o.location,organizer:o.organizer,allDay:_,start:c,end:a})}}function Ee(o){if(o.allDay)return"Ganztägig";const e=new Intl.DateTimeFormat("de-DE",{hour:"2-digit",minute:"2-digit"});return`${e.format(o.start)}–${e.format(o.end)}`}return(o,e)=>{const p=T("v-card-title"),c=T("v-text-field"),a=T("v-btn"),_=T("v-card-text"),h=T("v-card"),u=T("v-icon"),g=T("v-row"),f=T("v-col"),S=T("v-img"),D=T("v-alert-title"),x=T("v-alert"),$e=T("v-divider");return i(),m("div",null,[e[31]||(e[31]=d("h2",{class:"mt-6 text-center"},"Kalender",-1)),d("div",null,[!ee.value&&!Q(L)?(i(),C(h,{key:0,class:"mt-3 mb-4"},{default:s(()=>[n(p,null,{default:s(()=>[...e[9]||(e[9]=[k(" Termine anzeigen ",-1)])]),_:1}),n(_,null,{default:s(()=>[n(c,{modelValue:N.value,"onUpdate:modelValue":e[0]||(e[0]=t=>N.value=t),class:"mt-2","hide-details":"auto",label:"URL zur ics-Datei"},null,8,["modelValue"]),d("div",We,[n(a,{variant:"outlined",onClick:Te},{default:s(()=>[...e[10]||(e[10]=[k("Speichern",-1)])]),_:1})])]),_:1})]),_:1})):v("",!0),d("div",Fe,[d("div",He,[d("div",Le,[n(h,{class:"pa-2",variant:"elevated"},{default:s(()=>[n(_,null,{default:s(()=>[n(g,null,{default:s(()=>[n(a,{onClick:e[1]||(e[1]=t=>O(!1,-1))},{default:s(()=>[n(u,{icon:"mdi-chevron-left"})]),_:1}),d("div",Je,b(ne.value),1),n(a,{onClick:e[2]||(e[2]=t=>O(!1,1))},{default:s(()=>[n(u,{icon:"mdi-chevron-right"})]),_:1})]),_:1})]),_:1})]),_:1})])]),d("div",je," Offene Tage: "+b(De.value),1)]),(i(!0),m(X,null,Z(K.value,(t,Ue)=>(i(),m("div",{key:t.iso},[n(h,{class:"mt-2",flat:"",color:t.isBeforeToday?"rgb(236,236,236)":t.isToday?"rgb(183, 206, 226)":"white"},{default:s(()=>[n(p,{style:F({color:t.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[l.value[t.iso]?(i(),m("span",Ke,[n(u,{icon:"mdi-check",size:"30",color:"green"})])):v("",!0),l.value[t.iso]?v("",!0):(i(),m("span",Ye,[n(u,{icon:"mdi-close",size:"30",color:"red"})])),d("span",Ge,b(t.weekdayShort)+", "+b(t.date.getDate())+"."+b((t.date.getMonth()+1).toString().padStart(2,"0")),1),l.value[t.iso]&&!(!l.value[t.iso].cooked&&t.isBeforeToday)&&t.open?(i(),m("span",qe,[n(a,{variant:"plain",class:"ma-1",onClick:r=>be(t.iso)},{default:s(()=>[...e[11]||(e[11]=[k(" Löschen ",-1)])]),_:1},8,["onClick"])])):v("",!0),!t.open&&t.isBeforeToday&&l.value[t.iso]&&l.value[t.iso].cooked?(i(),m("span",Qe,[l.value[t.iso].type==="RECIPE"?(i(),m("span",Xe,[n(u,{icon:"mdi-bowl-mix",size:"30"})])):v("",!0),l.value[t.iso].type==="SCHEDULED"?(i(),m("span",Ze,[n(u,{icon:"mdi-food"})])):v("",!0),l.value[t.iso].type==="OTHER"?(i(),m("span",et,[n(u,{icon:"mdi-crosshairs-question"})])):v("",!0),n(a,{variant:"plain",class:"ma-1",onClick:r=>t.open=!0},{default:s(()=>[...e[12]||(e[12]=[k(" Aufklappen ",-1)])]),_:1},8,["onClick"])])):v("",!0)]),_:2},1032,["style"]),t.open||t.isBeforeToday&&l.value[t.iso]&&!l.value[t.iso].cooked?(i(),C(_,{key:0,style:{"min-height":"80px"}},{default:s(()=>[n(g,null,{default:s(()=>[n(f,{cols:o.$vuetify.display.mobile?12:4},{default:s(()=>[!t.isBeforeToday&&y.value>=0?(i(),C(h,{key:0,flat:"",color:"white"},{default:s(()=>[n(_,{class:"pa-1",style:F({color:t.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[(i(!0),m(X,null,Z(P.value[t.iso]??[],(r,ve)=>(i(),m("div",{key:ve},[r&&!r.recipe?(i(),m("div",tt,[d("div",null,[d("span",null,[d("b",null,b(Ee(r)),1)]),e[13]||(e[13]=k()),d("span",null,b(r.summary||"Ohne Titel"),1)])])):v("",!0)]))),128)),(P.value[t.iso]??[]).length===0?(i(),m("div",ot,"Keine Termine")):v("",!0)]),_:2},1032,["style"])]),_:2},1024)):v("",!0)]),_:2},1032,["cols"]),n(f,null,{default:s(()=>[l.value[t.iso]?v("",!0):(i(),m("div",lt,[d("div",null,[n(a,{"prepend-icon":"mdi-bowl-mix",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:r=>z(t.iso,"RECIPE"),disabled:t.isBeforeToday||Ce.value>=0},null,8,["onClick","disabled"]),n(a,{"prepend-icon":"mdi-food",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:r=>z(t.iso,"SCHEDULED"),disabled:t.isBeforeToday},null,8,["onClick","disabled"]),n(a,{"prepend-icon":"mdi-crosshairs-question",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:r=>z(t.iso,"OTHER"),disabled:t.isBeforeToday},null,8,["onClick","disabled"])])])),l.value[t.iso]&&l.value[t.iso].type==="RECIPE"?(i(),m("div",nt,[l.value[t.iso].recipeId?v("",!0):(i(),m("div",st,[n(g,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(u,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),n(f,{class:"pl-1 mt-4"},{default:s(()=>[e[16]||(e[16]=k(" Rezept ",-1)),n(a,{variant:"flat",color:l.value[t.iso].recipeId||l.value[t.iso].recipeSelection?"grey":"blue",onClick:r=>l.value[t.iso].recipeSelection=!1,class:"mb-1"},{default:s(()=>[...e[14]||(e[14]=[k("offen lassen",-1)])]),_:1},8,["color","onClick"]),e[17]||(e[17]=k(" oder ",-1)),n(a,{variant:"flat",color:l.value[t.iso].recipeId||l.value[t.iso].recipeSelection?"blue":"grey",onClick:r=>l.value[t.iso].recipeSelection=!0,class:"mb-1"},{default:s(()=>[...e[15]||(e[15]=[k("konkretes Rezept",-1)])]),_:1},8,["color","onClick"]),e[18]||(e[18]=k(" auswählen? ",-1))]),_:2},1024)]),_:2},1024)])),!l.value[t.iso].recipeId&&l.value[t.iso].recipeSelection?(i(),m("div",it,[e[19]||(e[19]=d("h3",null,"Bitte Rezept auswählen:",-1)),n(g,{align:"center"},{default:s(()=>[(i(!0),m(X,null,Z(Y.value,r=>(i(),C(f,{key:r.id,cols:"6"},{default:s(()=>[n(h,null,{default:s(()=>[(i(),C(S,{class:"position-relative",height:"100",src:se(r.id),key:V.value[r.id]?V.value[r.id]:0,style:F({opacity:j.value.includes(r.id)?.3:1}),cover:"",onClick:ve=>Se(t.iso,r.id)},null,8,["src","style","onClick"])),d("div",at,b(r.title||"Ohne Titel"),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)])):v("",!0),l.value[t.iso].recipeId?(i(),m("div",rt,[!l.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(i(),C(x,{key:0,type:"info",class:"mb-4",color:"rgb(166, 190, 226)"},{default:s(()=>[n(D,{style:{"font-size":"1.3em"}},{default:s(()=>[e[22]||(e[22]=k("Wurde diese Mahlzeit zubereitet? ",-1)),n(a,{variant:"outlined",onClick:r=>G(t.iso),class:"ml-3"},{default:s(()=>[...e[20]||(e[20]=[k("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?v("",!0):(i(),C(a,{key:0,variant:"outlined",onClick:r=>z(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[21]||(e[21]=[k("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):v("",!0),n(g,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(u,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[(i(),C(S,{class:"position-relative",height:"120",src:se(l.value[t.iso].recipeId),key:V.value[l.value[t.iso].recipeId]?V.value[l.value[t.iso].recipeId]:0,style:F([{opacity:t.isBeforeToday?.6:1},{cursor:"pointer"}]),color:"grey",onClick:r=>ie(l.value[t.iso].recipeId),cover:""},null,8,["src","style","onClick"])),d("div",{style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em",cursor:"pointer"},class:"pl-1",onClick:r=>ie(l.value[t.iso].recipeId)},b(l.value[t.iso].recipeTitle||"Ohne Titel"),9,ut)]),_:2},1024)]),_:2},1024)])):v("",!0)])):v("",!0),l.value[t.iso]&&l.value[t.iso].type==="SCHEDULED"?(i(),m("div",ct,[!l.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(i(),C(x,{key:0,type:"info",class:"mb-4",color:"rgb(166, 190, 226)"},{default:s(()=>[n(D,{style:{"font-size":"1.3em"}},{default:s(()=>[e[25]||(e[25]=k("Wurde diese Mahlzeit verzehrt? ",-1)),n(a,{variant:"outlined",onClick:r=>G(t.iso),class:"ml-3"},{default:s(()=>[...e[23]||(e[23]=[k("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?v("",!0):(i(),C(a,{key:0,variant:"outlined",onClick:r=>z(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[24]||(e[24]=[k("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):v("",!0),n(g,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(u,{icon:"mdi-food",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[d("div",null,[e[26]||(e[26]=d("div",null," Auswärts / Lieferung ",-1)),d("div",null,[n(c,{label:"Notizen (optional)",modelValue:l.value[t.iso].recipeTitle,"onUpdate:modelValue":r=>l.value[t.iso].recipeTitle=r,onKeyup:e[3]||(e[3]=r=>Q(pe).debounceTime("scheduledPlanTitle",R,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):v("",!0),l.value[t.iso]&&l.value[t.iso].type==="OTHER"?(i(),m("div",dt,[!l.value[t.iso].cooked&&(t.isBeforeToday||t.isToday)?(i(),C(x,{key:0,type:"info",class:"mb-2",color:"rgb(166, 190, 226)"},{default:s(()=>[n(D,{style:{"font-size":"1.3em"}},{default:s(()=>[e[29]||(e[29]=k("Wurde diese Mahlzeit verzehrt? ",-1)),n(a,{variant:"outlined",onClick:r=>G(t.iso),class:"ml-3"},{default:s(()=>[...e[27]||(e[27]=[k("Ja",-1)])]),_:1},8,["onClick"]),t.isToday?v("",!0):(i(),C(a,{key:0,variant:"outlined",onClick:r=>z(t.iso,null),class:"ml-1",color:"grey darken-1"},{default:s(()=>[...e[28]||(e[28]=[k("Nein",-1)])]),_:1},8,["onClick"]))]),_:2},1024)]),_:2},1024)):v("",!0),n(g,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(u,{icon:"mdi-crosshairs-question",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"ml-2 pl-1"},{default:s(()=>[d("div",null,[e[30]||(e[30]=d("div",null," Sonstiges ",-1)),d("div",null,[n(c,{label:"Notizen (optional)",modelValue:l.value[t.iso].recipeTitle,"onUpdate:modelValue":r=>l.value[t.iso].recipeTitle=r,onKeyup:e[4]||(e[4]=r=>Q(pe).debounceTime("otherPlanNotes",R,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):v("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)):v("",!0)]),_:2},1032,["color"]),Ue!==K.value.length-1?(i(),C($e,{key:0,class:"my-2",opacity:"0.7"})):v("",!0)]))),128)),d("div",vt,[d("div",ft,[n(h,{class:"pa-2",variant:"elevated"},{default:s(()=>[n(_,null,{default:s(()=>[n(g,null,{default:s(()=>[n(a,{onClick:e[5]||(e[5]=t=>O(!0,-1))},{default:s(()=>[n(u,{icon:"mdi-chevron-left"})]),_:1}),d("div",mt,b(ne.value),1),n(a,{onClick:e[6]||(e[6]=t=>O(!0,1))},{default:s(()=>[n(u,{icon:"mdi-chevron-right"})]),_:1})]),_:1})]),_:1})]),_:1})])])]),n(Oe,{onResult:e[7]||(e[7]=t=>ye.value=t)}),n(Be,{onResult:e[8]||(e[8]=t=>le.value=t),title:"Bitte bestätigen",message:"Soll die ausgewählte Mahlzeit für den Tag gelöscht werden?"})])}}},gt=Pe(pt,[["__scopeId","data-v-3011f85f"]]),Ct={__name:"index",setup(_e){return ke(async()=>{ge()}),(H,B)=>(i(),C(gt))}};export{Ct as default};
