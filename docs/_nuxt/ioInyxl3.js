import{_ as Ee,M as Re,N as ue,O as ze,J as $e,P as xe,K as ce,r as k,o as ve,k as B,g as w,x as p,y as u,z as c,B as n,Q as C,R as y,U as q,C as s,D as h,A as T,S as Q,T as Z,Z as H}from"./CocLNjjF.js";import{I as $}from"./DA__SF9z.js";import{a as X,I as Ue}from"./3qU261Hc.js";import{R as Pe}from"./BxZt3kzm.js";import{G as de}from"./CI608YEO.js";const Ve={class:"text-right mt-3"},Be={class:"mt-3 mb-3"},Me={class:"d-flex flex-column align-center"},Ne={class:"mt-2"},Oe={key:0},Fe={key:1},Ae={key:0},He={key:0},We={key:0},je={key:1},Ke={key:0},Le={style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em"},class:"pl-1"},Je={key:1},Ye=["onClick"],Ge={key:2},qe={key:3},Qe={key:4,class:"mt-1"},Ze={class:"w-100"},Xe={class:"mt-3 mb-3"},et={class:"d-flex flex-column align-center"},tt={__name:"MealCalendar",setup(fe){const W=Re(),{recipes:x}=ue(W);ze(),$e(),xe();const S=ce(),{authInfo:M,githubMode:j,lanAddress:me}=ue(S),N=k(""),ee=k(!0),K=k(null),te=k(!1),oe=k("");k(null),k(!1);const U=k({}),l=k({}),b=k(0),L=k([]),pe=new Date,O=k({}),ge=k(null),_e=k(null);ve(async()=>{console.log("mounted");let t=await S.getAuthInfo();t.icsUrl?(N.value=t.icsUrl,X.fetchIcsData(t.userId,t.icsUrl).then(e=>{setTimeout(()=>{K.value=e.data,Te()},200)})):ee.value=!1,await we(),se()}),B(()=>x.value.filter(t=>!!t.planned));const ye=B(()=>{if(!l.value)return 0;let t=0,e=l.value;new Date().setHours(0,0,0,0);const a=new Date;a.setHours(23,59,59,0);for(let r=b.value*7;r<(b.value+1)*7;r++){const D=V(E,r);if(D.getTime()>a.getTime()){const g=D.getFullYear(),v=String(D.getMonth()+1).padStart(2,"0"),m=String(D.getDate()).padStart(2,"0");(!e[`${g}-${v}-${m}`]||e[`${g}-${v}-${m}`].type==="RECIPE"&&!e[`${g}-${v}-${m}`].recipeId)&&t++}}return t}),J=B(()=>x.value.filter(t=>!!t.planned&&!t.cooked));async function ke(){await X.saveIcsUrl(M.value.userId,N.value),se()}function le(t){return t?j.value?"https://mmhhhh.de/data/home/recipes/"+t+"/image.jpg":me.value+"api/"+M.value.userId+"/recipes/"+t+"/image":""}async function F(t,e){if(!e){delete l.value[t],P(),await z(),await S.refreshPlannendUntil();return}l.value[t]||(l.value[t]={}),l.value[t].type=e,await z(),await S.refreshPlannendUntil()}async function De(t,e){if(!e){delete l.value[t],P(),await z(),await S.refreshPlannendUntil();return}for(const a of Object.keys(l.value))l.value[a]&&!l.value[a].cooked&&l.value[a].recipeId===e&&delete l.value[a];l.value[t]||(l.value[t]={});const i=x.value.find(a=>a.id===e);l.value[t].recipeId=e,l.value[t].recipeTitle=i.title,P(),await z(),await S.refreshPlannendUntil()}async function ne(t){j.value?window.open("https://mmhhhh.de/recipes/go?id="+t,"_blank","noopener"):window.open("/recipes/go?id="+t,"_blank","noopener")}async function we(){x.value=await W.getAllRecipes(M.value.userId)}async function se(){let t=await S.getAuthInfo();l.value=t.calendarPlan??{},console.log("plansByDay",l.value);for(const e of Object.keys(l.value))l.value[e]&&l.value[e].type==="RECIPE"&&!l.value[e].recipeId&&delete l.value[e];P()}function P(){L.value=[];for(const t of Object.keys(l.value))l.value[t]&&!l.value[t].cooked&&l.value[t].recipeId&&J.value.map(e=>e.id).includes(l.value[t].recipeId)&&L.value.push(l.value[t].recipeId)}function A(t){P(),t&&window.scrollTo({top:0,behavior:"smooth"})}async function z(){await X.saveCalendarPlan(M.value.userId,l.value)}function he(t){const e=new Date(t),i=e.getDay()||7;return i!==1&&e.setDate(e.getDate()-(i-1)),e.setHours(0,0,0,0),e}function V(t,e){const i=new Date(t);return i.setDate(i.getDate()+e),i}function Y(t){const e=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${e}-${i}-${a}`}const ae=new Intl.DateTimeFormat("de-DE",{weekday:"short"}),E=he(pe),be=B(()=>{const t=new Date;t.setHours(0,0,0,0),new Date().setHours(23,59,59,0);const i=[];for(let a=b.value*7;a<(b.value+1)*7;a++){const r=V(E,a);i.push({date:r,iso:Y(r),weekdayShort:ae.format(r),isBeforeToday:r.getTime()<t.getTime(),isToday:Ie(r)})}return i});B(()=>{const t=[];for(let e=0;e<14;e++){const i=V(E,e);t.push({date:i,iso:Y(i),weekdayShort:ae.format(i)})}return t});function Ie(t){const e=new Date;return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}function Te(){if(oe.value="",!!K.value){te.value=!0;try{const t=K.value,e=$.parse(t),i=new $.Component(e),a=$.Time.fromJSDate(E,!0),r=$.Time.fromJSDate(V(E,14),!0),D=i.getAllSubcomponents("vevent");for(const g of D){const v=new $.Event(g);if(v.startDate)if(v.isRecurring()){const m=new $.RecurExpansion({component:g,dtstart:v.startDate});for(;;){const f=m.next();if(!f||f.compare(r)>=0)break;if(f.compare(a)<0)continue;const I=f;let _;v.duration?(_=I.clone(),_.addDuration(v.duration)):v.endDate?_=v.endDate.clone():_=I.clone(),ie(v,I,_)}}else{const m=v.startDate,f=v.endDate||m;f.compare(a)<=0||m.compare(r)>=0||ie(v,m,f)}}}catch(t){console.error(t),oe.value="Kalender konnte nicht geladen werden. (CORS/URL/Format prüfen)"}finally{te.value=!1}}}function ie(t,e,i){const a=e.toJSDate(),r=i.toJSDate(),D=e.isDate,g=new Date(r);D&&g.setDate(g.getDate()-1);const v=E,m=V(E,13),f=a<v?v:a,I=g>m?m:g;for(let _=new Date(f.getFullYear(),f.getMonth(),f.getDate());_<=I;_.setDate(_.getDate()+1)){const R=Y(_);U.value[R]||(U.value[R]=[]),U.value[R].push({summary:t.summary,location:t.location,organizer:t.organizer,allDay:D,start:a,end:r})}}function Ce(t){if(t.allDay)return"Ganztägig";const e=new Intl.DateTimeFormat("de-DE",{hour:"2-digit",minute:"2-digit"});return`${e.format(t.start)}–${e.format(t.end)}`}return(t,e)=>{const i=w("v-card-title"),a=w("v-text-field"),r=w("v-btn"),D=w("v-card-text"),g=w("v-card"),v=w("v-btn-toggle"),m=w("v-icon"),f=w("v-col"),I=w("v-img"),_=w("v-row"),R=w("v-alert-title"),G=w("v-alert"),Se=w("v-divider");return u(),p("div",null,[e[25]||(e[25]=c("h2",{class:"mt-6 text-center"},"Kalender",-1)),c("div",null,[!ee.value&&!q(j)?(u(),C(g,{key:0,class:"mt-3 mb-4"},{default:s(()=>[n(i,null,{default:s(()=>[...e[11]||(e[11]=[h(" Termine anzeigen ",-1)])]),_:1}),n(D,null,{default:s(()=>[n(a,{modelValue:N.value,"onUpdate:modelValue":e[0]||(e[0]=o=>N.value=o),class:"mt-2","hide-details":"auto",label:"URL zur ics-Datei"},null,8,["modelValue"]),c("div",Ve,[n(r,{variant:"outlined",onClick:ke},{default:s(()=>[...e[12]||(e[12]=[h("Speichern",-1)])]),_:1})])]),_:1})]),_:1})):y("",!0),c("div",Be,[c("div",Me,[n(v,{modelValue:b.value,"onUpdate:modelValue":e[3]||(e[3]=o=>b.value=o),color:"primary",border:"",mandatory:""},{default:s(()=>[n(r,{value:0,style:{"font-size":"0.7em"},onClick:e[1]||(e[1]=o=>A(!1))},{default:s(()=>[...e[13]||(e[13]=[h("Diese Woche",-1)])]),_:1}),n(r,{value:1,style:{"font-size":"0.7em"},onClick:e[2]||(e[2]=o=>A(!1))},{default:s(()=>[...e[14]||(e[14]=[h("Nächste Woche",-1)])]),_:1})]),_:1},8,["modelValue"])]),c("div",Ne," Offene Tage: "+T(ye.value),1)]),(u(!0),p(Q,null,Z(be.value,(o,lt)=>(u(),p("div",{key:o.iso},[n(g,{class:"mt-2",flat:"",color:o.isBeforeToday?"rgb(236,236,236)":o.isToday?"rgb(183, 206, 226)":"white"},{default:s(()=>[n(i,{style:H({color:o.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[l.value[o.iso]&&(l.value[o.iso].type==="SCHEDULED"||l.value[o.iso].type==="OTHER"||l.value[o.iso].type==="RECIPE"&&l.value[o.iso].recipeId)?(u(),p("span",Oe,[n(m,{icon:"mdi-check",size:"30",color:"green"})])):y("",!0),!l.value[o.iso]||l.value[o.iso].type==="RECIPE"&&!l.value[o.iso].recipeId?(u(),p("span",Fe,[n(m,{icon:"mdi-close",size:"30",color:"red"})])):y("",!0),h(" "+T(o.weekdayShort)+", "+T(o.date.getDate())+"."+T((o.date.getMonth()+1).toString().padStart(2,"0")),1)]),_:2},1032,["style"]),n(D,{style:{"min-height":"80px"}},{default:s(()=>[n(_,null,{default:s(()=>[n(f,{cols:t.$vuetify.display.mobile?12:4},{default:s(()=>[n(g,{flat:"",color:"white"},{default:s(()=>[n(D,{class:"pa-1",style:H({color:o.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[(u(!0),p(Q,null,Z(U.value[o.iso]??[],(d,re)=>(u(),p("div",{key:re},[d&&!d.recipe?(u(),p("div",Ae,[c("div",null,[c("span",null,[c("b",null,T(Ce(d)),1)]),e[15]||(e[15]=h()),c("span",null,T(d.summary||"Ohne Titel"),1)])])):y("",!0)]))),128)),(U.value[o.iso]??[]).length===0?(u(),p("div",He,"Keine Termine")):y("",!0)]),_:2},1032,["style"])]),_:2},1024)]),_:2},1032,["cols"]),n(f,null,{default:s(()=>[l.value[o.iso]?y("",!0):(u(),p("div",We,[c("div",null,[n(r,{"prepend-icon":"mdi-bowl-mix",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:d=>F(o.iso,"RECIPE"),disabled:o.isBeforeToday||J.value.length===0},null,8,["onClick","disabled"]),n(r,{"prepend-icon":"mdi-calendar-alert",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:d=>F(o.iso,"SCHEDULED"),disabled:o.isBeforeToday},null,8,["onClick","disabled"]),n(r,{"prepend-icon":"mdi-crosshairs-question",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:d=>F(o.iso,"OTHER"),disabled:o.isBeforeToday},null,8,["onClick","disabled"])])])),l.value[o.iso]&&l.value[o.iso].type==="RECIPE"?(u(),p("div",je,[l.value[o.iso].recipeId?y("",!0):(u(),p("div",Ke,[e[16]||(e[16]=c("h3",null,"Bitte Rezept auswählen:",-1)),n(_,{align:"center"},{default:s(()=>[(u(!0),p(Q,null,Z(J.value,d=>(u(),C(f,{key:d.id,cols:"6"},{default:s(()=>[n(g,null,{default:s(()=>[(u(),C(I,{class:"position-relative",height:"100",src:le(d.id),key:O.value[d.id]?O.value[d.id]:0,style:H({opacity:L.value.includes(d.id)?.3:1}),cover:"",onClick:re=>De(o.iso,d.id)},null,8,["src","style","onClick"])),c("div",Le,T(d.title||"Ohne Titel"),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)])),l.value[o.iso].recipeId?(u(),p("div",Je,[l.value[o.iso].cooked?(u(),C(G,{key:0,type:"info",class:"mb-2"},{default:s(()=>[n(R,{style:{"font-size":"1.3em"}},{default:s(()=>[...e[17]||(e[17]=[h("Dieses Gericht wurde bereits zubereitet.",-1)])]),_:1})]),_:1})):y("",!0),n(_,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(m,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[(u(),C(I,{class:"position-relative",height:"120",src:le(l.value[o.iso].recipeId),key:O.value[l.value[o.iso].recipeId]?O.value[l.value[o.iso].recipeId]:0,style:H([{opacity:o.isBeforeToday?.6:1},{cursor:"pointer"}]),color:"grey",onClick:d=>ne(l.value[o.iso].recipeId),cover:""},null,8,["src","style","onClick"])),c("div",{style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em",cursor:"pointer"},class:"pl-1",onClick:d=>ne(l.value[o.iso].recipeId)},T(l.value[o.iso].recipeTitle||"Ohne Titel"),9,Ye)]),_:2},1024)]),_:2},1024)])):y("",!0)])):y("",!0),l.value[o.iso]&&l.value[o.iso].type==="SCHEDULED"?(u(),p("div",Ge,[l.value[o.iso].cooked?(u(),C(G,{key:0,type:"info",class:"mb-2"},{default:s(()=>[n(R,{style:{"font-size":"1.3em"}},{default:s(()=>[...e[18]||(e[18]=[h("Diese Mahlzeit wurde bereits verzehrt.",-1)])]),_:1})]),_:1})):y("",!0),n(_,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(m,{icon:"mdi-calendar-alert",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[c("div",null,[e[19]||(e[19]=c("div",null," Absprache ",-1)),c("div",null,[n(a,{label:"Notizen (optional)",modelValue:l.value[o.iso].recipeTitle,"onUpdate:modelValue":d=>l.value[o.iso].recipeTitle=d,onKeyup:e[4]||(e[4]=d=>q(de).debounceTime("scheduledPlanTitle",z,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):y("",!0),l.value[o.iso]&&l.value[o.iso].type==="OTHER"?(u(),p("div",qe,[l.value[o.iso].cooked?(u(),C(G,{key:0,type:"info",class:"mb-2"},{default:s(()=>[n(R,{style:{"font-size":"1.3em"}},{default:s(()=>[...e[20]||(e[20]=[h("Diese Mahlzeit wurde bereits verzehrt.",-1)])]),_:1})]),_:1})):y("",!0),n(_,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(m,{icon:"mdi-crosshairs-question",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[c("div",null,[e[21]||(e[21]=c("div",null," Sonstiges ",-1)),c("div",null,[n(a,{label:"Name des Rezepts (optional)",modelValue:l.value[o.iso].recipeTitle,"onUpdate:modelValue":d=>l.value[o.iso].recipeTitle=d,onKeyup:e[5]||(e[5]=d=>q(de).debounceTime("otherPlanNotes",z,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):y("",!0),l.value[o.iso]?(u(),p("div",Qe,[c("div",Ze,[n(r,{variant:"outlined",class:"ma-1 w-100",onClick:d=>F(o.iso,null)},{default:s(()=>[...e[22]||(e[22]=[h(" Eintrag löschen ",-1)])]),_:1},8,["onClick"])])])):y("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["color"]),n(Se,{class:"my-2",opacity:"0.7"})]))),128)),c("div",Xe,[c("div",et,[n(v,{modelValue:b.value,"onUpdate:modelValue":e[8]||(e[8]=o=>b.value=o),color:"primary",border:"",mandatory:""},{default:s(()=>[n(r,{value:0,style:{"font-size":"0.7em"},onClick:e[6]||(e[6]=o=>A(!0))},{default:s(()=>[...e[23]||(e[23]=[h("Diese Woche",-1)])]),_:1}),n(r,{value:1,style:{"font-size":"0.7em"},onClick:e[7]||(e[7]=o=>A(!0))},{default:s(()=>[...e[24]||(e[24]=[h("Nächste Woche",-1)])]),_:1})]),_:1},8,["modelValue"])])])]),n(Ue,{onResult:e[9]||(e[9]=o=>ge.value=o)}),n(Pe,{onResult:e[10]||(e[10]=o=>_e.value=o)})])}}},ot=Ee(tt,[["__scopeId","data-v-840b5909"]]),ut={__name:"index",setup(fe){return ve(async()=>{ce()}),(W,x)=>(u(),C(ot))}};export{ut as default};
