import{_ as Ce,M as Re,N as re,O as Ee,J as xe,P as $e,K as de,r as y,o as ce,k as N,g as D,x as _,y as c,z as u,B as n,Q as C,R as b,U as J,C as s,D as h,A as S,S as G,T as q,Y as H}from"./B1Xk-5O6.js";import{I as x}from"./DA__SF9z.js";import{a as Q,I as ze}from"./CQuVgmf0.js";import{R as Ue}from"./8gljmcbZ.js";import{G as ue}from"./CI608YEO.js";const Pe={class:"text-right mt-3"},Ve={class:"mt-3 mb-3"},Be={class:"d-flex flex-column align-center"},Ne={class:"mt-2"},Fe={key:0},Oe={key:0},Ae={key:0},Me={key:1},He={key:0},We={style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em"},class:"pl-1"},je={key:1},Ke={style:{"background-color":"rgb(166, 190, 226)","font-size":"0.7em"},class:"pl-1"},Le={key:2},Ye={key:3},Je={key:4,class:"mt-1"},Ge={class:"w-100"},qe={class:"mt-3 mb-3"},Qe={class:"d-flex flex-column align-center"},Xe={__name:"MealCalendar",setup(ve){const W=Re(),{recipes:$}=re(W);Ee(),xe(),$e();const R=de(),{authInfo:z,githubMode:X,lanAddress:fe}=re(R),F=y(""),Z=y(!0),j=y(null),ee=y(!1),te=y("");y(null),y(!1);const U=y({}),o=y({}),w=y(0),K=y([]),me=new Date,O=y({}),pe=y(null),ge=y(null);ce(async()=>{let t=await R.getAuthInfo();t.icsUrl?(F.value=t.icsUrl,Q.fetchIcsData(t.userId,t.icsUrl).then(e=>{j.value=e.data,Te()})):Z.value=!1,await De(),ne()}),N(()=>$.value.filter(t=>!!t.planned));const _e=N(()=>{if(!o.value)return 0;let t=0,e=o.value;new Date().setHours(0,0,0,0);const a=new Date;a.setHours(23,59,59,0);for(let r=w.value*7;r<(w.value+1)*7;r++){const k=V(I,r);if(k.getTime()>a.getTime()){const m=k.getFullYear(),v=String(k.getMonth()+1).padStart(2,"0"),g=String(k.getDate()).padStart(2,"0");(!e[`${m}-${v}-${g}`]||e[`${m}-${v}-${g}`].type==="RECIPE"&&!e[`${m}-${v}-${g}`].recipeId)&&t++}}return t}),le=N(()=>$.value.filter(t=>!!t.planned&&!t.cooked));async function ye(){await Q.saveIcsUrl(z.value.userId,F.value),ne()}function oe(t){return t?X.value?"https://mmhhhh.de/data/home/recipes/"+t+"/image.jpg":fe.value+"api/"+z.value.userId+"/recipes/"+t+"/image":""}function A(t,e){if(!e){delete o.value[t],P(),E(),R.refreshPlannendUntil();return}o.value[t]||(o.value[t]={}),o.value[t].type=e,E(),R.refreshPlannendUntil()}function ke(t,e){if(!e){delete o.value[t],P(),E(),R.refreshPlannendUntil();return}for(const a of Object.keys(o.value))o.value[a]&&!o.value[a].cooked&&o.value[a].recipeId===e&&delete o.value[a];o.value[t]||(o.value[t]={});const i=$.value.find(a=>a.id===e);o.value[t].recipeId=e,o.value[t].recipeTitle=i.title,P(),E(),R.refreshPlannendUntil()}async function De(){$.value=await W.getAllRecipes(z.value.userId)}async function ne(){o.value=z.value.calendarPlan??{};for(const t of Object.keys(o.value))o.value[t]&&o.value[t].type==="RECIPE"&&!o.value[t].recipeId&&delete o.value[t];P()}function P(){K.value=[];for(const t of Object.keys(o.value))o.value[t]&&!o.value[t].cooked&&o.value[t].recipeId&&le.value.map(e=>e.id).includes(o.value[t].recipeId)&&K.value.push(o.value[t].recipeId)}function M(t){P(),t&&window.scrollTo({top:0,behavior:"smooth"})}async function E(){await Q.saveCalendarPlan(z.value.userId,o.value)}function be(t){const e=new Date(t),i=e.getDay()||7;return i!==1&&e.setDate(e.getDate()-(i-1)),e.setHours(0,0,0,0),e}function V(t,e){const i=new Date(t);return i.setDate(i.getDate()+e),i}function L(t){const e=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${e}-${i}-${a}`}const se=new Intl.DateTimeFormat("de-DE",{weekday:"short"}),I=be(me),he=N(()=>{const t=new Date;t.setHours(0,0,0,0),new Date().setHours(23,59,59,0);const i=[];for(let a=w.value*7;a<(w.value+1)*7;a++){const r=V(I,a);i.push({date:r,iso:L(r),weekdayShort:se.format(r),isBeforeToday:r.getTime()<t.getTime(),isToday:we(r)})}return i});N(()=>{const t=[];for(let e=0;e<14;e++){const i=V(I,e);t.push({date:i,iso:L(i),weekdayShort:se.format(i)})}return t});function we(t){const e=new Date;return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}function Te(){if(te.value="",!!j.value){ee.value=!0;try{const t=j.value,e=x.parse(t),i=new x.Component(e),a=x.Time.fromJSDate(I,!0),r=x.Time.fromJSDate(V(I,14),!0),k=i.getAllSubcomponents("vevent");for(const m of k){const v=new x.Event(m);if(v.startDate)if(v.isRecurring()){const g=new x.RecurExpansion({component:m,dtstart:v.startDate});for(;;){const f=g.next();if(!f||f.compare(r)>=0)break;if(f.compare(a)<0)continue;const T=f;let p;v.duration?(p=T.clone(),p.addDuration(v.duration)):v.endDate?p=v.endDate.clone():p=T.clone(),ae(v,T,p)}}else{const g=v.startDate,f=v.endDate||g;f.compare(a)<=0||g.compare(r)>=0||ae(v,g,f)}}}catch(t){console.error(t),te.value="Kalender konnte nicht geladen werden. (CORS/URL/Format prüfen)"}finally{ee.value=!1}}}function ae(t,e,i){const a=e.toJSDate(),r=i.toJSDate(),k=e.isDate,m=new Date(r);k&&m.setDate(m.getDate()-1);const v=I,g=V(I,13),f=a<v?v:a,T=m>g?g:m;for(let p=new Date(f.getFullYear(),f.getMonth(),f.getDate());p<=T;p.setDate(p.getDate()+1)){const B=L(p);U.value[B]||(U.value[B]=[]),U.value[B].push({summary:t.summary,location:t.location,organizer:t.organizer,allDay:k,start:a,end:r})}}function Se(t){if(t.allDay)return"Ganztägig";const e=new Intl.DateTimeFormat("de-DE",{hour:"2-digit",minute:"2-digit"});return`${e.format(t.start)}–${e.format(t.end)}`}return(t,e)=>{const i=D("v-card-title"),a=D("v-text-field"),r=D("v-btn"),k=D("v-card-text"),m=D("v-card"),v=D("v-btn-toggle"),g=D("v-alert"),f=D("v-col"),T=D("v-img"),p=D("v-row"),B=D("v-alert-title"),Y=D("v-icon"),Ie=D("v-divider");return c(),_("div",null,[e[24]||(e[24]=u("h2",{class:"mt-6 text-center"},"Kalender",-1)),u("div",null,[!Z.value&&!J(X)?(c(),C(m,{key:0,class:"mt-3 mb-4"},{default:s(()=>[n(i,null,{default:s(()=>[...e[11]||(e[11]=[h(" Termine anzeigen ",-1)])]),_:1}),n(k,null,{default:s(()=>[n(a,{modelValue:F.value,"onUpdate:modelValue":e[0]||(e[0]=l=>F.value=l),class:"mt-2","hide-details":"auto",label:"URL zur ics-Datei"},null,8,["modelValue"]),u("div",Pe,[n(r,{variant:"outlined",onClick:ye},{default:s(()=>[...e[12]||(e[12]=[h("Speichern",-1)])]),_:1})])]),_:1})]),_:1})):b("",!0),u("div",Ve,[u("div",Be,[n(v,{modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=l=>w.value=l),color:"primary",border:"",mandatory:""},{default:s(()=>[n(r,{value:0,style:{"font-size":"0.7em"},onClick:e[1]||(e[1]=l=>M(!1))},{default:s(()=>[...e[13]||(e[13]=[h("Diese Woche",-1)])]),_:1}),n(r,{value:1,style:{"font-size":"0.7em"},onClick:e[2]||(e[2]=l=>M(!1))},{default:s(()=>[...e[14]||(e[14]=[h("Nächste Woche",-1)])]),_:1})]),_:1},8,["modelValue"])]),u("div",Ne," Offene Tage: "+S(_e.value),1)]),(c(!0),_(G,null,q(he.value,(l,et)=>(c(),_("div",{key:l.iso},[n(m,{class:"mt-2",flat:"",color:l.isBeforeToday?"rgb(236,236,236)":l.isToday?"rgb(183, 206, 226)":"white"},{default:s(()=>[n(i,{style:H({color:l.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[h(S(l.weekdayShort)+", "+S(l.date.getDate())+"."+S((l.date.getMonth()+1).toString().padStart(2,"0")),1)]),_:2},1032,["style"]),!l.isBeforeToday&&(!o.value[l.iso]||o.value[l.iso].type==="RECIPE"&&!o.value[l.iso].recipeId)?(c(),C(g,{key:0,type:"error",color:"rgb(233, 181, 181)",class:"mx-3"},{default:s(()=>[...e[15]||(e[15]=[h("Noch nicht geplant!",-1)])]),_:1})):b("",!0),n(k,{style:{"min-height":"80px"}},{default:s(()=>[n(p,null,{default:s(()=>[n(f,{cols:t.$vuetify.display.mobile?12:4},{default:s(()=>[n(m,{flat:"",color:"white"},{default:s(()=>[n(k,{class:"pa-1",style:H({color:l.isBeforeToday?"rgb(165,165,165)":null})},{default:s(()=>[(c(!0),_(G,null,q(U.value[l.iso]??[],(d,ie)=>(c(),_("div",{key:ie},[d&&!d.recipe?(c(),_("div",Fe,[u("div",null,[u("span",null,[u("b",null,S(Se(d)),1)]),e[16]||(e[16]=h()),u("span",null,S(d.summary||"Ohne Titel"),1)])])):b("",!0)]))),128)),(U.value[l.iso]??[]).length===0?(c(),_("div",Oe,"Keine Termine")):b("",!0)]),_:2},1032,["style"])]),_:2},1024)]),_:2},1032,["cols"]),n(f,null,{default:s(()=>[o.value[l.iso]?b("",!0):(c(),_("div",Ae,[u("div",null,[n(r,{"prepend-icon":"mdi-bowl-mix",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:d=>A(l.iso,"RECIPE"),disabled:l.isBeforeToday},null,8,["onClick","disabled"]),n(r,{"prepend-icon":"mdi-calendar-alert",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:d=>A(l.iso,"SCHEDULED"),disabled:l.isBeforeToday},null,8,["onClick","disabled"]),n(r,{"prepend-icon":"mdi-crosshairs-question",color:"rgb(84, 109, 139)",size:"50",class:"ma-1",onClick:d=>A(l.iso,"OTHER"),disabled:l.isBeforeToday},null,8,["onClick","disabled"])])])),o.value[l.iso]&&o.value[l.iso].type==="RECIPE"?(c(),_("div",Me,[o.value[l.iso].recipeId?b("",!0):(c(),_("div",He,[e[17]||(e[17]=u("h3",null,"Bitte Rezept auswählen:",-1)),n(p,{align:"center"},{default:s(()=>[(c(!0),_(G,null,q(le.value,d=>(c(),C(f,{key:d.id,cols:"6"},{default:s(()=>[n(m,null,{default:s(()=>[(c(),C(T,{class:"position-relative",height:"100",src:oe(d.id),key:O.value[d.id]?O.value[d.id]:0,style:H({opacity:K.value.includes(d.id)?.3:1}),cover:"",onClick:ie=>ke(l.iso,d.id)},null,8,["src","style","onClick"])),u("div",We,S(d.title||"Ohne Titel"),1)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)])),o.value[l.iso].recipeId?(c(),_("div",je,[o.value[l.iso].cooked?(c(),C(g,{key:0,type:"info",class:"mb-1"},{default:s(()=>[n(B,{style:{"font-size":"1.3em"}},{default:s(()=>[...e[18]||(e[18]=[h("Diese Planung ist veraltet!",-1)])]),_:1})]),_:1})):b("",!0),n(p,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(Y,{icon:"mdi-bowl-mix",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[(c(),C(T,{class:"position-relative",height:"120",src:oe(o.value[l.iso].recipeId),key:O.value[o.value[l.iso].recipeId]?O.value[o.value[l.iso].recipeId]:0,style:H({opacity:l.isBeforeToday?.6:1}),color:"grey",cover:""},null,8,["src","style"])),u("div",Ke,S(o.value[l.iso].recipeTitle||"Ohne Titel"),1)]),_:2},1024)]),_:2},1024)])):b("",!0)])):b("",!0),o.value[l.iso]&&o.value[l.iso].type==="SCHEDULED"?(c(),_("div",Le,[n(p,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(Y,{icon:"mdi-calendar-alert",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[u("div",null,[e[19]||(e[19]=u("div",null," Absprache ",-1)),u("div",null,[n(a,{label:"Notizen (optional)",modelValue:o.value[l.iso].recipeTitle,"onUpdate:modelValue":d=>o.value[l.iso].recipeTitle=d,onKeyup:e[4]||(e[4]=d=>J(ue).debounceTime("scheduledPlanTitle",E,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):b("",!0),o.value[l.iso]&&o.value[l.iso].type==="OTHER"?(c(),_("div",Ye,[n(p,{"no-gutters":""},{default:s(()=>[n(f,{cols:"3"},{default:s(()=>[n(Y,{icon:"mdi-crosshairs-question",size:"50"})]),_:1}),n(f,{style:{"font-size":"1.6em"},class:"pl-1"},{default:s(()=>[u("div",null,[e[20]||(e[20]=u("div",null," Sonstiges ",-1)),u("div",null,[n(a,{label:"Name des Rezepts (optional)",modelValue:o.value[l.iso].recipeTitle,"onUpdate:modelValue":d=>o.value[l.iso].recipeTitle=d,onKeyup:e[5]||(e[5]=d=>J(ue).debounceTime("otherPlanNotes",E,300))},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024)])):b("",!0),o.value[l.iso]?(c(),_("div",Je,[u("div",Ge,[n(r,{variant:"outlined",class:"ma-1 w-100",onClick:d=>A(l.iso,null)},{default:s(()=>[...e[21]||(e[21]=[h(" Auswahl löschen ",-1)])]),_:1},8,["onClick"])])])):b("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["color"]),n(Ie,{class:"my-2",opacity:"0.7"})]))),128)),u("div",qe,[u("div",Qe,[n(v,{modelValue:w.value,"onUpdate:modelValue":e[8]||(e[8]=l=>w.value=l),color:"primary",border:"",mandatory:""},{default:s(()=>[n(r,{value:0,style:{"font-size":"0.7em"},onClick:e[6]||(e[6]=l=>M(!0))},{default:s(()=>[...e[22]||(e[22]=[h("Diese Woche",-1)])]),_:1}),n(r,{value:1,style:{"font-size":"0.7em"},onClick:e[7]||(e[7]=l=>M(!0))},{default:s(()=>[...e[23]||(e[23]=[h("Nächste Woche",-1)])]),_:1})]),_:1},8,["modelValue"])])])]),n(ze,{onResult:e[9]||(e[9]=l=>pe.value=l)}),n(Ue,{onResult:e[10]||(e[10]=l=>ge.value=l)})])}}},Ze=Ce(Xe,[["__scopeId","data-v-21461b24"]]),at={__name:"index",setup(ve){return ce(async()=>{de()}),(W,$)=>(c(),C(Ze))}};export{at as default};
